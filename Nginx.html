<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-b5506197d8.css">
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p>
<div class="toc">
 <h3><a name="t0"></a><a name="t0"></a>目录</h3>
 <ul><li><ul><li><a href="#_Nginx_3" target="_self">第一章 Nginx概述</a></li><li><ul><li><a href="#11Nginx_5" target="_self">1.1、Nginx概述</a></li><li><a href="#12Nginx_9" target="_self">1.2、Nginx官网</a></li><li><a href="#13Nginx_13" target="_self">1.3、Nginx用处</a></li></ul>
   </li><li><a href="#_Nginx_17" target="_self">第二章 Nginx单实例安装</a></li><li><ul><li><a href="#21_19" target="_self">2.1、环境说明</a></li><li><a href="#22_26" target="_self">2.2、安装依赖</a></li><li><a href="#23Nginx_32" target="_self">2.3、Nginx下载</a></li><li><a href="#24Nginx_38" target="_self">2.4、Nginx解压</a></li><li><a href="#25Nginx_44" target="_self">2.5、Nginx安装</a></li><li><a href="#26Nginx_54" target="_self">2.6、Nginx命令</a></li><li><a href="#27_64" target="_self">2.7、开放防火墙</a></li><li><a href="#28_72" target="_self">2.8、启动后效果</a></li></ul>
   </li><li><a href="#_Nginx_76" target="_self">第三章 Nginx反向代理</a></li><li><ul><li><a href="#31_78" target="_self">3.1、概述</a></li><li><a href="#321_82" target="_self">3.2、配置反向代理实例1</a></li><li><ul><li><a href="#321_84" target="_self">3.2.1、实现效果</a></li><li><a href="#322_90" target="_self">3.2.2、实现思路</a></li><li><a href="#323_94" target="_self">3.2.3、实现步骤</a></li><li><a href="#324_172" target="_self">3.2.4、关闭服务</a></li></ul>
    </li><li><a href="#332_179" target="_self">3.3、配置反向代理实例2</a></li><li><ul><li><a href="#331_181" target="_self">3.3.1、实现效果</a></li><li><a href="#332_187" target="_self">3.3.2、实现思路</a></li><li><a href="#333_191" target="_self">3.3.3、实现步骤</a></li><li><a href="#334_414" target="_self">3.3.4、关闭服务</a></li></ul>
    </li><li><a href="#34location_422" target="_self">3.4、location指令说明</a></li></ul>
   </li><li><a href="#_Nginx_439" target="_self">第四章 Nginx负载均衡</a></li><li><ul><li><a href="#41_441" target="_self">4.1、概述</a></li><li><a href="#42_453" target="_self">4.2、实现效果</a></li><li><a href="#43_459" target="_self">4.3、实现思路</a></li><li><a href="#44_463" target="_self">4.4、实现步骤</a></li><li><a href="#45_520" target="_self">4.5、关闭服务</a></li><li><a href="#46_528" target="_self">4.6、分配策略</a></li></ul>
   </li><li><a href="#_Nginx_554" target="_self">第五章 Nginx动静分离</a></li><li><ul><li><a href="#51_556" target="_self">5.1、概述</a></li><li><a href="#52_560" target="_self">5.2、实现效果</a></li><li><a href="#53_566" target="_self">5.3、实现思路</a></li><li><a href="#54_570" target="_self">5.4、实现步骤</a></li><li><a href="#55_618" target="_self">5.5、关闭服务</a></li></ul>
   </li><li><a href="#_Nginx_625" target="_self">第六章 Nginx高可用集群</a></li><li><ul><li><a href="#61_627" target="_self">6.1、概述</a></li><li><a href="#62_631" target="_self">6.2、实现效果</a></li><li><a href="#63_635" target="_self">6.3、实现思路</a></li><li><a href="#64_639" target="_self">6.4、实现步骤</a></li><li><a href="#65_950" target="_self">6.5、关闭服务</a></li></ul>
   </li><li><a href="#_Nginx_968" target="_self">第七章 Nginx配置详解</a></li><li><ul><li><a href="#71_972" target="_self">7.1、整体结构图</a></li><li><a href="#72_976" target="_self">7.2、配置演示图</a></li><li><a href="#73_980" target="_self">7.3、全局块</a></li><li><a href="#74events_1012" target="_self">7.4、events块</a></li><li><a href="#75http_1030" target="_self">7.5、http块</a></li><li><a href="#76server_1077" target="_self">7.6、server块</a></li><li><a href="#77location_1126" target="_self">7.7、location块</a></li></ul>
   </li><li><a href="#_Nginx_1175" target="_self">第八章 Nginx原理分析</a></li><li><ul><li><a href="#81nginx_1177" target="_self">8.1、nginx的线程模型？</a></li><li><a href="#82worker_1185" target="_self">8.2、worker的工作模式？</a></li><li><a href="#83worker_1191" target="_self">8.3、如何计算worker连接数？</a></li><li><a href="#84_1196" target="_self">8.4、如何计算最大的并发数？</a></li></ul>
  </li></ul>
 </li></ul>
</div>
<p></p> 
<hr> 
<h2><a name="t1"></a><a name="t1"></a><a id="_Nginx_3"></a>第一章 Nginx概述</h2> 
<h3><a name="t2"></a><a name="t2"></a><a id="11Nginx_5"></a>1.1、Nginx概述</h3> 
<p>Nginx (“engine x”) 是一个高性能的 HTTP 和反向代理服务器，特点是占有内存少，并发能力强，事实上 Nginx 的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用 Nginx 网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p> 
<h3><a name="t3"></a><a name="t3"></a><a id="12Nginx_9"></a>1.2、Nginx官网</h3> 
<p>官网地址：<a href="http://nginx.org/">点击打开</a></p> 
<h3><a name="t4"></a><a name="t4"></a><a id="13Nginx_13"></a>1.3、Nginx用处</h3> 
<p>Nginx 可以作为静态页面的 web 服务器，同时还支持 CGI 协议的动态语言，比如 perl、php 等。但是不支持 Java。Java 程序只能通过与 tomcat 配合完成。Nginx 专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率，能经受高负载的考验，有报告表明能支持高达 50000 个并发连接数。</p> 
<h2><a name="t5"></a><a name="t5"></a><a id="_Nginx_17"></a>第二章 Nginx单实例安装</h2> 
<h3><a name="t6"></a><a name="t6"></a><a id="21_19"></a>2.1、环境说明</h3> 
<ul><li>模拟工具：VMware-workstation-full-15.5.6-16341506.exe</li><li>操作系统：CentOS-6.10-x86_64-bin-DVD1.iso、纯净安装、桌面版</li><li>内存大小：2GB</li><li>连接工具：SecureCRT</li></ul> 
<h3><a name="t7"></a><a name="t7"></a><a id="22_26"></a>2.2、安装依赖</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># yum install -y gcc gcc-c++ make libtool wget pcre pcre-devel zlib zlib-devel openssl openssl-devel</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t8"></a><a name="t8"></a><a id="23Nginx_32"></a>2.3、Nginx下载</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># wget http://nginx.org/download/nginx-1.18.0.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t9"></a><a name="t9"></a><a id="24Nginx_38"></a>2.4、Nginx解压</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf nginx-1.18.0.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t10"></a><a name="t10"></a><a id="25Nginx_44"></a>2.5、Nginx安装</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># cd nginx-1.18.0</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># ./configure</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<blockquote> 
 <p>注意：安装完成后的路径为：/usr/local/nginx</p> 
</blockquote> 
<h3><a name="t11"></a><a name="t11"></a><a id="26Nginx_54"></a>2.6、Nginx命令</h3> 
<ul><li>普通启动服务：/usr/local/nginx/sbin/nginx</li><li>配置文件启动：/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</li><li>暴力停止服务：/usr/local/nginx/sbin/nginx -s stop</li><li>优雅停止服务：/usr/local/nginx/sbin/nginx -s quit</li><li>检查配置文件：/usr/local/nginx/sbin/nginx -t</li><li>重新加载配置：/usr/local/nginx/sbin/nginx -s reload</li><li>查看相关进程：ps -ef | grep nginx</li></ul> 
<h3><a name="t12"></a><a name="t12"></a><a id="27_64"></a>2.7、开放防火墙</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
iptables：将防火墙规则保存到 /etc/sysconfig/iptables：<span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<h3><a name="t13"></a><a name="t13"></a><a id="28_72"></a>2.8、启动后效果</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgxNzQ4MzIucG5n?x-oss-process=image/format,png" alt="image-20200828174831270"></p> 
<h2><a name="t14"></a><a name="t14"></a><a id="_Nginx_76"></a>第三章 Nginx反向代理</h2> 
<h3><a name="t15"></a><a name="t15"></a><a id="31_78"></a>3.1、概述</h3> 
<p>Nginx 不仅可以做反向代理，还能用作正向代理来进行上网等功能，正向代理：如果把局域网外的 Internet 想象成一个巨大的资源库，则局域网中的客户端要访问 Internet，则需要通过代理服务器来访问，这种代理服务就称为正向代理。对于反向代理，客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器 IP 地址。</p> 
<h3><a name="t16"></a><a name="t16"></a><a id="321_82"></a>3.2、配置反向代理实例1</h3> 
<h4><a id="321_84"></a>3.2.1、实现效果</h4> 
<p>打开浏览器，在浏览器地址栏输入地址：http://www.123.com，跳转到 Liunx 系统 Tomcat 主页面中。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMDU5MzYucG5n?x-oss-process=image/format,png" alt="image-20200828205934132"></p> 
<h4><a id="322_90"></a>3.2.2、实现思路</h4> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMDU4NDUucG5n?x-oss-process=image/format,png" alt="image-20200828205843914"></p> 
<h4><a id="323_94"></a>3.2.3、实现步骤</h4> 
<p><strong>步骤一：修改Windows中的hosts域名映射</strong></p> 
<p>复制“ C:\Windows\System32\drivers\etc\hosts ”到桌面，右键记事本打开，在里边加上以下代码保存，然后再复制回去，不要直接修改，会不让保存！</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token comment">#虚拟机域名       映射的网址</span>
192.168.206.128 www.123.com
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p><strong>步骤二：修改Nginx中的配置文件并启动</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass http:127.0.0.1:8080<span class="token punctuation">;</span>
            root   html<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>步骤三：下载Tomcat、解压Tomcat、安装Tomcat、启动Tomcat</strong></p> 
<blockquote> 
 <p>注意：Tomcat启动需要JDK，在这里我没有安装，使用系统自带的OpenJDK Runtime Environment (rhel-2.6.14.10.el6-x86_64 u181-b00)</p> 
</blockquote> 
<p>下载：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.bit.edu.cn/apache/tomcat/tomcat-7/v7.0.105/bin/apache-tomcat-7.0.105.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>解压：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-7.0.105.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>安装：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-7.0.105 /usr/local/tomcat</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>启动：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/startup.sh	</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>添加到防火墙：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>如果关闭请用：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h4><a id="324_172"></a>3.2.4、关闭服务</h4> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<h3><a name="t17"></a><a name="t17"></a><a id="332_179"></a>3.3、配置反向代理实例2</h3> 
<h4><a id="331_181"></a>3.3.1、实现效果</h4> 
<p>使用 nginx 反向代理，根据访问的路径跳转到不同端口的服务中。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjI4MDcucG5n?x-oss-process=image/format,png" alt="image-20200828222806664"></p> 
<h4><a id="332_187"></a>3.3.2、实现思路</h4> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMTI1NDkucG5n?x-oss-process=image/format,png" alt="image-20200828212546015"></p> 
<h4><a id="333_191"></a>3.3.3、实现步骤</h4> 
<p><strong>步骤一：修改Nginx的配置文件，然后启动</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location ~ /edu/ <span class="token punctuation">{<!-- --></span>
            proxy_pass http://127.0.0.1:8080<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ /vod/ <span class="token punctuation">{<!-- --></span>
            proxy_pass http://127.0.0.1:8081<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>步骤二：拷贝两个Tomcat，将其中一个的端口信息修改为8081，开启防火墙，然后分别启动这两台Tomcat</strong></p> 
<p>解压：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-7.0.105.tar.gz</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-7.0.105 /usr/local/tomcat1</span>

<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-7.0.105.tar.gz</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-7.0.105 /usr/local/tomcat2</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>删除：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># rm -f /usr/local/tomcat2/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>添加：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/tomcat2/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">'1.0'</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>--
  Licensed to the Apache Software Foundation <span class="token punctuation">(</span>ASF<span class="token punctuation">)</span> under one or <span class="token function">more</span>
  contributor license agreements.  See the NOTICE <span class="token function">file</span> distributed with
  this work <span class="token keyword">for</span> additional information regarding copyright ownership.
  The ASF licenses this <span class="token function">file</span> to You under the Apache License, Version 2.0
  <span class="token punctuation">(</span>the <span class="token string">"License"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> you may not use this <span class="token function">file</span> except <span class="token keyword">in</span> compliance with
  the License.  You may obtain a copy of the License at
      http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to <span class="token keyword">in</span> writing, software
  distributed under the License is distributed on an <span class="token string">"AS IS"</span> BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License <span class="token keyword">for</span> the specific language governing permissions and
  limitations under the License.
--<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>-- Note:  A <span class="token string">"Server"</span> is not itself a <span class="token string">"Container"</span>, so you may not
     define subcomponents such as <span class="token string">"Valves"</span> at this level.
     Documentation at /docs/config/server.html
 --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Server port<span class="token operator">=</span><span class="token string">"8006"</span> shutdown<span class="token operator">=</span><span class="token string">"SHUTDOWN"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.startup.VersionLoggerListener"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>-- Security listener. Documentation at /docs/config/listeners.html
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.security.SecurityListener"</span> /<span class="token operator">&gt;</span>
  --<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>--APR library loader. Documentation at /docs/apr.html --<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.AprLifecycleListener"</span> SSLEngine<span class="token operator">=</span><span class="token string">"on"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>--Initialize Jasper prior to webapps are loaded. Documentation at /docs/jasper-howto.html --<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.JasperListener"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>-- Prevent memory leaks due to use of particular java/javax APIs--<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>-- Global JNDI resources
       Documentation at /docs/jndi-resources-howto.html
  --<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>GlobalNamingResources<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- Editable user database that can also be used by
         UserDatabaseRealm to authenticate <span class="token function">users</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Resource name<span class="token operator">=</span><span class="token string">"UserDatabase"</span> auth<span class="token operator">=</span><span class="token string">"Container"</span>
              type<span class="token operator">=</span><span class="token string">"org.apache.catalina.UserDatabase"</span>
              description<span class="token operator">=</span><span class="token string">"User database that can be updated and saved"</span>
              factory<span class="token operator">=</span><span class="token string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span>
              pathname<span class="token operator">=</span><span class="token string">"conf/tomcat-users.xml"</span> /<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/GlobalNamingResources<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>-- A <span class="token string">"Service"</span> is a collection of one or <span class="token function">more</span> <span class="token string">"Connectors"</span> that share
       a single <span class="token string">"Container"</span> Note:  A <span class="token string">"Service"</span> is not itself a <span class="token string">"Container"</span>,
       so you may not define subcomponents such as <span class="token string">"Valves"</span> at this level.
       Documentation at /docs/config/service.html
   --<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Service name<span class="token operator">=</span><span class="token string">"Catalina"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>--The connectors can use a shared executor, you can define one or <span class="token function">more</span> named thread pools--<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>--
    <span class="token operator">&lt;</span>Executor name<span class="token operator">=</span><span class="token string">"tomcatThreadPool"</span> namePrefix<span class="token operator">=</span><span class="token string">"catalina-exec-"</span>
        maxThreads<span class="token operator">=</span><span class="token string">"150"</span> minSpareThreads<span class="token operator">=</span><span class="token string">"4"</span>/<span class="token operator">&gt;</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- A <span class="token string">"Connector"</span> represents an endpoint by <span class="token function">which</span> requests are received
         and responses are returned. Documentation at <span class="token keyword">:</span>
         Java HTTP Connector: /docs/config/http.html <span class="token punctuation">(</span>blocking <span class="token operator">&amp;</span> non-blocking<span class="token punctuation">)</span>
         Java AJP  Connector: /docs/config/ajp.html
         APR <span class="token punctuation">(</span>HTTP/AJP<span class="token punctuation">)</span> Connector: /docs/apr.html
         Define a non-SSL HTTP/1.1 Connector on port 8080
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Connector port<span class="token operator">=</span><span class="token string">"8081"</span> protocol<span class="token operator">=</span><span class="token string">"HTTP/1.1"</span>
               connectionTimeout<span class="token operator">=</span><span class="token string">"20000"</span>
               redirectPort<span class="token operator">=</span><span class="token string">"8444"</span> /<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- A <span class="token string">"Connector"</span> using the shared thread pool--<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>--
    <span class="token operator">&lt;</span>Connector executor<span class="token operator">=</span><span class="token string">"tomcatThreadPool"</span>
               port<span class="token operator">=</span><span class="token string">"8081"</span> protocol<span class="token operator">=</span><span class="token string">"HTTP/1.1"</span>
               connectionTimeout<span class="token operator">=</span><span class="token string">"20000"</span>
               redirectPort<span class="token operator">=</span><span class="token string">"8444"</span> /<span class="token operator">&gt;</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- Define an SSL HTTP/1.1 Connector on port 8443
         This connector uses the BIO implementation that requires the JSSE
         style configuration. When using the APR/native implementation, the
         OpenSSL style configuration is required as described <span class="token keyword">in</span> the APR/native
         documentation --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>--
    <span class="token operator">&lt;</span>Connector port<span class="token operator">=</span><span class="token string">"8444"</span> protocol<span class="token operator">=</span><span class="token string">"org.apache.coyote.http11.Http11Protocol"</span>
               maxThreads<span class="token operator">=</span><span class="token string">"150"</span> SSLEnabled<span class="token operator">=</span><span class="token string">"true"</span> scheme<span class="token operator">=</span><span class="token string">"https"</span> secure<span class="token operator">=</span><span class="token string">"true"</span>
               clientAuth<span class="token operator">=</span><span class="token string">"false"</span> sslProtocol<span class="token operator">=</span><span class="token string">"TLS"</span> /<span class="token operator">&gt;</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- Define an AJP 1.3 Connector on port 8009 --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>--
    <span class="token operator">&lt;</span>Connector protocol<span class="token operator">=</span><span class="token string">"AJP/1.3"</span>
               address<span class="token operator">=</span><span class="token string">"::1"</span>
               port<span class="token operator">=</span><span class="token string">"8010"</span>
               redirectPort<span class="token operator">=</span><span class="token string">"8444"</span> /<span class="token operator">&gt;</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- An Engine represents the entry point <span class="token punctuation">(</span>within Catalina<span class="token punctuation">)</span> that processes
         every request.  The Engine implementation <span class="token keyword">for</span> Tomcat stand alone
         analyzes the HTTP headers included with the request, and passes them
         on to the appropriate Host <span class="token punctuation">(</span>virtual host<span class="token punctuation">)</span>.
         Documentation at /docs/config/engine.html --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- You should <span class="token keyword">set</span> jvmRoute to support load-balancing via AJP ie <span class="token keyword">:</span>
    <span class="token operator">&lt;</span>Engine name<span class="token operator">=</span><span class="token string">"Catalina"</span> defaultHost<span class="token operator">=</span><span class="token string">"localhost"</span> jvmRoute<span class="token operator">=</span><span class="token string">"jvm1"</span><span class="token operator">&gt;</span>
    --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Engine name<span class="token operator">=</span><span class="token string">"Catalina"</span> defaultHost<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span>--For clustering, please take a <span class="token function">look</span> at documentation at:
          /docs/cluster-howto.html  <span class="token punctuation">(</span>simple how to<span class="token punctuation">)</span>
          /docs/config/cluster.html <span class="token punctuation">(</span>reference documentation<span class="token punctuation">)</span> --<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span>--
      <span class="token operator">&lt;</span>Cluster className<span class="token operator">=</span><span class="token string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span>/<span class="token operator">&gt;</span>
      --<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span>-- Use the LockOutRealm to prevent attempts to guess user passwords
           via a brute-force attack --<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.LockOutRealm"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span>-- This Realm uses the UserDatabase configured <span class="token keyword">in</span> the global JNDI
             resources under the key <span class="token string">"UserDatabase"</span><span class="token keyword">.</span>  Any edits
             that are performed against this UserDatabase are immediately
             available <span class="token keyword">for</span> use by the Realm.  --<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.UserDatabaseRealm"</span>
               resourceName<span class="token operator">=</span><span class="token string">"UserDatabase"</span>/<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>/Realm<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Host name<span class="token operator">=</span><span class="token string">"localhost"</span>  appBase<span class="token operator">=</span><span class="token string">"webapps"</span>
            unpackWARs<span class="token operator">=</span><span class="token string">"true"</span> autoDeploy<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span>-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html --<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span>--
        <span class="token operator">&lt;</span>Valve className<span class="token operator">=</span><span class="token string">"org.apache.catalina.authenticator.SingleSignOn"</span> /<span class="token operator">&gt;</span>
        --<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span>-- Access log processes all example.
             Documentation at: /docs/config/valve.html
             Note: The pattern used is equivalent to using pattern<span class="token operator">=</span><span class="token string">"common"</span> --<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Valve className<span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> directory<span class="token operator">=</span><span class="token string">"logs"</span>
               prefix<span class="token operator">=</span><span class="token string">"localhost_access_log."</span> suffix<span class="token operator">=</span><span class="token string">".txt"</span>
               pattern<span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>/Host<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/Engine<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/Service<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/Server<span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li><li style="color: rgb(153, 153, 153);">34</li><li style="color: rgb(153, 153, 153);">35</li><li style="color: rgb(153, 153, 153);">36</li><li style="color: rgb(153, 153, 153);">37</li><li style="color: rgb(153, 153, 153);">38</li><li style="color: rgb(153, 153, 153);">39</li><li style="color: rgb(153, 153, 153);">40</li><li style="color: rgb(153, 153, 153);">41</li><li style="color: rgb(153, 153, 153);">42</li><li style="color: rgb(153, 153, 153);">43</li><li style="color: rgb(153, 153, 153);">44</li><li style="color: rgb(153, 153, 153);">45</li><li style="color: rgb(153, 153, 153);">46</li><li style="color: rgb(153, 153, 153);">47</li><li style="color: rgb(153, 153, 153);">48</li><li style="color: rgb(153, 153, 153);">49</li><li style="color: rgb(153, 153, 153);">50</li><li style="color: rgb(153, 153, 153);">51</li><li style="color: rgb(153, 153, 153);">52</li><li style="color: rgb(153, 153, 153);">53</li><li style="color: rgb(153, 153, 153);">54</li><li style="color: rgb(153, 153, 153);">55</li><li style="color: rgb(153, 153, 153);">56</li><li style="color: rgb(153, 153, 153);">57</li><li style="color: rgb(153, 153, 153);">58</li><li style="color: rgb(153, 153, 153);">59</li><li style="color: rgb(153, 153, 153);">60</li><li style="color: rgb(153, 153, 153);">61</li><li style="color: rgb(153, 153, 153);">62</li><li style="color: rgb(153, 153, 153);">63</li><li style="color: rgb(153, 153, 153);">64</li><li style="color: rgb(153, 153, 153);">65</li><li style="color: rgb(153, 153, 153);">66</li><li style="color: rgb(153, 153, 153);">67</li><li style="color: rgb(153, 153, 153);">68</li><li style="color: rgb(153, 153, 153);">69</li><li style="color: rgb(153, 153, 153);">70</li><li style="color: rgb(153, 153, 153);">71</li><li style="color: rgb(153, 153, 153);">72</li><li style="color: rgb(153, 153, 153);">73</li><li style="color: rgb(153, 153, 153);">74</li><li style="color: rgb(153, 153, 153);">75</li><li style="color: rgb(153, 153, 153);">76</li><li style="color: rgb(153, 153, 153);">77</li><li style="color: rgb(153, 153, 153);">78</li><li style="color: rgb(153, 153, 153);">79</li><li style="color: rgb(153, 153, 153);">80</li><li style="color: rgb(153, 153, 153);">81</li><li style="color: rgb(153, 153, 153);">82</li><li style="color: rgb(153, 153, 153);">83</li><li style="color: rgb(153, 153, 153);">84</li><li style="color: rgb(153, 153, 153);">85</li><li style="color: rgb(153, 153, 153);">86</li><li style="color: rgb(153, 153, 153);">87</li><li style="color: rgb(153, 153, 153);">88</li><li style="color: rgb(153, 153, 153);">89</li><li style="color: rgb(153, 153, 153);">90</li><li style="color: rgb(153, 153, 153);">91</li><li style="color: rgb(153, 153, 153);">92</li><li style="color: rgb(153, 153, 153);">93</li><li style="color: rgb(153, 153, 153);">94</li><li style="color: rgb(153, 153, 153);">95</li><li style="color: rgb(153, 153, 153);">96</li><li style="color: rgb(153, 153, 153);">97</li><li style="color: rgb(153, 153, 153);">98</li><li style="color: rgb(153, 153, 153);">99</li><li style="color: rgb(153, 153, 153);">100</li><li style="color: rgb(153, 153, 153);">101</li><li style="color: rgb(153, 153, 153);">102</li><li style="color: rgb(153, 153, 153);">103</li><li style="color: rgb(153, 153, 153);">104</li><li style="color: rgb(153, 153, 153);">105</li><li style="color: rgb(153, 153, 153);">106</li><li style="color: rgb(153, 153, 153);">107</li><li style="color: rgb(153, 153, 153);">108</li><li style="color: rgb(153, 153, 153);">109</li><li style="color: rgb(153, 153, 153);">110</li><li style="color: rgb(153, 153, 153);">111</li><li style="color: rgb(153, 153, 153);">112</li><li style="color: rgb(153, 153, 153);">113</li><li style="color: rgb(153, 153, 153);">114</li><li style="color: rgb(153, 153, 153);">115</li><li style="color: rgb(153, 153, 153);">116</li><li style="color: rgb(153, 153, 153);">117</li><li style="color: rgb(153, 153, 153);">118</li><li style="color: rgb(153, 153, 153);">119</li><li style="color: rgb(153, 153, 153);">120</li><li style="color: rgb(153, 153, 153);">121</li><li style="color: rgb(153, 153, 153);">122</li><li style="color: rgb(153, 153, 153);">123</li><li style="color: rgb(153, 153, 153);">124</li><li style="color: rgb(153, 153, 153);">125</li><li style="color: rgb(153, 153, 153);">126</li><li style="color: rgb(153, 153, 153);">127</li><li style="color: rgb(153, 153, 153);">128</li><li style="color: rgb(153, 153, 153);">129</li><li style="color: rgb(153, 153, 153);">130</li><li style="color: rgb(153, 153, 153);">131</li><li style="color: rgb(153, 153, 153);">132</li></ul></pre> 
<p>开启Tomcat2的防火墙：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 8081 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>在每一个Tomcat的webapps中创建一个文件夹和一个a.html文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat1/webapps/edu</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;This is 8080 Port&lt;/h1&gt;" &gt; /usr/local/tomcat1/webapps/edu/a.html</span>

<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat2/webapps/vod</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;This is 8081 Port&lt;/h1&gt;" &gt; /usr/local/tomcat2/webapps/vod/a.html</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>启动：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/startup.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p><strong>步骤三：打开本机浏览器进行测试</strong></p> 
<p>在浏览器输入 http://192.168.206.128/edu/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjI1MzUucG5n?x-oss-process=image/format,png" alt="image-20200828222533350"></p> 
<p>在浏览器输入 http://192.168.206.128/vod/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjI3NDEucG5n?x-oss-process=image/format,png" alt="image-20200828222740051"></p> 
<h4><a id="334_414"></a>3.3.4、关闭服务</h4> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/shutdown.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<h3><a name="t18"></a><a name="t18"></a><a id="34location_422"></a>3.4、location指令说明</h3> 
<p>描述：该指令用于匹配URL</p> 
<p>语法：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjUxMDcucG5n?x-oss-process=image/format,png" alt="image-20200828225104660"></p> 
<p>通配符：</p> 
<ul><li>= ：用于不含正则表达式的 uri 前，要求请求字符串与 uri 严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</li><li>~ ：用于表示 uri 包含正则表达式，并且区分大小写。</li><li>~* ：用于表示 uri 包含正则表达式，并且不区分大小写。</li><li>^~ ：用于不含正则表达式的 uri 前，要求 Nginx 服务器找到标识 uri 和请求字符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location 块中的正则 uri 和请求字符串做匹配。</li></ul> 
<blockquote> 
 <p>注意：如果 uri 包含正则表达式，则必须要有 ~ 或者 ~* 标识。</p> 
</blockquote> 
<h2><a name="t19"></a><a name="t19"></a><a id="_Nginx_439"></a>第四章 Nginx负载均衡</h2> 
<h3><a name="t20"></a><a name="t20"></a><a id="41_441"></a>4.1、概述</h3> 
<p>客户端发送多个请求到服务器，服务器处理请求，有一些可能要与数据库进行交互，服务器处理完毕后，再将结果返回给客户端。</p> 
<p>这种架构模式对于早期的系统相对单一，并发请求相对较少的情况下是比较适合的，成本也低。但是随着信息数量的不断增长，访问量和数据量的飞速增长，以及系统业务的复杂度增加，这种架构会造成服务器相应客户端的请求日益缓慢，并发量特别大的时候，还容易造成服务器直接崩溃。很明显这是由于服务器性能的瓶颈造成的问题，那么如何解决这种情况呢？</p> 
<p>我们首先想到的可能是升级服务器的配置，比如提高 CPU 执行频率，加大内存等提高机器的物理性能来解决此问题，但是我们知道摩尔定律的日益失效，硬件的性能提升已经不能满足日益提升的需求了。最明显的一个例子，天猫双十一当天，某个热销商品的瞬时访问量是极其庞大的，那么类似上面的系统架构，将机器都增加到现有的顶级物理配置，都是不能够满足需求的。那么怎么办呢？</p> 
<p>上面的分析我们去掉了增加服务器物理配置来解决问题的办法，也就是说纵向解决问题的办法行不通了，那么横向增加服务器的数量呢？这时候集群的概念产生了，单个服务器解决不了，我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们所说的负载均衡。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjM2NTkucG5n?x-oss-process=image/format,png" alt="image-20200828223657994"></p> 
<h3><a name="t21"></a><a name="t21"></a><a id="42_453"></a>4.2、实现效果</h3> 
<p>浏览器地址栏输入地址 http://192.168.206.128/edu/a.html，负载均衡效果，将请求平均到 8080 和 8081 端口中。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMjE1MTYucG5n?x-oss-process=image/format,png" alt="image-20200829221513568"></p> 
<h3><a name="t22"></a><a name="t22"></a><a id="43_459"></a>4.3、实现思路</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMzAwMjEucG5n?x-oss-process=image/format,png" alt="image-20200828230020365"></p> 
<h3><a name="t23"></a><a name="t23"></a><a id="44_463"></a>4.4、实现步骤</h3> 
<p><strong>第一步：修改Nginx的配置文件</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    upstream myserver <span class="token punctuation">{<!-- --></span>
        server 192.168.206.128:8080<span class="token punctuation">;</span>
        server 192.168.206.128:8081<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass http://myserver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第二步：在Tomcat2的webapps文件夹中，创建一个edu文件夹，在里边创建a.html</strong></p> 
<p>创建：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat2/webapps/edu</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;This is 8081 Port&lt;/h1&gt;" &gt; /usr/local/tomcat2/webapps/edu/a.html</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>启动：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/startup.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p><strong>第三步：测试效果</strong></p> 
<p>打开IE浏览器输入：http://192.168.206.128/edu/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDAzMjMucG5n?x-oss-process=image/format,png" alt="image-20200829000320869"></p> 
<p>打开IE浏览器输入： http://192.168.206.128/edu/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDA0MDMucG5n?x-oss-process=image/format,png" alt="image-20200829000402015"></p> 
<h3><a name="t24"></a><a name="t24"></a><a id="45_520"></a>4.5、关闭服务</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/shutdown.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<h3><a name="t25"></a><a name="t25"></a><a id="46_528"></a>4.6、分配策略</h3> 
<ul><li>轮询（默认）：</li></ul> 
<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDEyNTcucG5n?x-oss-process=image/format,png" alt="image-20200829001256456"></p> 
<ul><li>weight：</li></ul> 
<p>weight 代表权重，默认为1，权重越高被分配的客户端越多，weight 和访问比率成正比，用于后端服务器性能不均的情况。 例如：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDA5MzIucG5n?x-oss-process=image/format,png" alt="image-20200829000931253"></p> 
<ul><li>ip_hash：</li></ul> 
<p>每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。 例如：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDEwNTUucG5n?x-oss-process=image/format,png" alt="image-20200829001054083"></p> 
<ul><li>fair（第三方）：</li></ul> 
<p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。例如：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkwMDExMjMucG5n?x-oss-process=image/format,png" alt="image-20200829001122167"></p> 
<h2><a name="t26"></a><a name="t26"></a><a id="_Nginx_554"></a>第五章 Nginx动静分离</h2> 
<h3><a name="t27"></a><a name="t27"></a><a id="51_556"></a>5.1、概述</h3> 
<p>Nginx 动静分离简单来说就是把动态跟静态请求分开，不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成使用 Nginx 处理静态页面，Tomcat 处理动态页面。动静分离从目前实现角度来讲大致分为两种，一种是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案；另外一种方法就是动态跟静态文件混合在一起发布，通过 Nginx 来分开。</p> 
<h3><a name="t28"></a><a name="t28"></a><a id="52_560"></a>5.2、实现效果</h3> 
<p>如果不设置动静分离，默认会通过Nginx的反向代理去找Tomcat对应的资源，现在我们在根目录下创建一个/data/www/文件夹，里边放上静态资源，比如一个html页面，在8080的那台Tomcat的webapps下也创建一个www目录，同样是放一个静态资源，当输入这个静态资源的请求时，访问到的是/data/www中的数据</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkxNjIzNDIucG5n?x-oss-process=image/format,png" alt="20200829162342"></p> 
<h3><a name="t29"></a><a name="t29"></a><a id="53_566"></a>5.3、实现思路</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkxODM2NTcucG5n?x-oss-process=image/format,png" alt="image-20200829155724452"></p> 
<h3><a name="t30"></a><a name="t30"></a><a id="54_570"></a>5.4、实现步骤</h3> 
<p><strong>第一步：创建静态资源文件，为了对比，tomcat中也放一个</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/www/</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat/webapps/ROOT/www</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;/data/www/a.html&lt;/h1&gt;" &gt; /data/www/a.html</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;/usr/local/tomcat/webapps/ROOT/www/a.html&lt;/h1&gt;" &gt; /usr/local/tomcat/webapps/ROOT/www/a.html</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li></ul></pre> 
<p><strong>第二步：修改Nginx的配置文件</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location /www/ <span class="token punctuation">{<!-- --></span>
            root /data/<span class="token punctuation">;</span>
            index index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第三步：启动Tomcat</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第四步：启动浏览器进行测试</strong></p> 
<p>打开浏览器输入： http://192.168.206.128/www/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkxNjI0NTEucG5n?x-oss-process=image/format,png" alt="20200829162451"></p> 
<h3><a name="t31"></a><a name="t31"></a><a id="55_618"></a>5.5、关闭服务</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<h2><a name="t32"></a><a name="t32"></a><a id="_Nginx_625"></a>第六章 Nginx高可用集群</h2> 
<h3><a name="t33"></a><a name="t33"></a><a id="61_627"></a>6.1、概述</h3> 
<p>前边我们学习了反向代理、负载均衡、动静分离，但试想一下，如果Nginx挂掉了，那么服务肯定就没有了，有没有一种解决方案，可以保证Nginx挂掉了，服务也可以照常使用，答案肯定是有的，这就是我们接下来要学习的高可用集群，采用的是一主一备的模式，当主节点Nginx挂掉，备份服务器Nginx立刻跟上，这样就保证了服务的高可用性。</p> 
<h3><a name="t34"></a><a name="t34"></a><a id="62_631"></a>6.2、实现效果</h3> 
<p>当主节点Nginx挂掉以后，服务依然可以正常使用。</p> 
<h3><a name="t35"></a><a name="t35"></a><a id="63_635"></a>6.3、实现思路</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkxODM2NDkucG5n?x-oss-process=image/format,png" alt="image-20200829183351647"></p> 
<h3><a name="t36"></a><a name="t36"></a><a id="64_639"></a>6.4、实现步骤</h3> 
<p><strong>第一步：修改主节点上的Nginx的配置文件</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    upstream myserver <span class="token punctuation">{<!-- --></span>
        server 192.168.206.128:8080<span class="token punctuation">;</span>
        server 192.168.206.128:8081<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass http://myserver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第二步：启动主节点上的两台Tomcat</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/startup.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p><strong>第三步：安装主节点上的keepalived</strong></p> 
<p>安装keepalived：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># yum install -y keepalived</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>删除keepalived的配置文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># rm -f /etc/keepalived/keepalived.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>新增keepalived的配置文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<blockquote> 
 <p>注意：一定要注意router_id、state、interface的值，我就在这里踩坑了</p> 
</blockquote> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived

global_defs <span class="token punctuation">{<!-- --></span>
   notification_email <span class="token punctuation">{<!-- --></span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   <span class="token comment">#邮件服务器通知地址（暂不配置，默认即可）</span>
   smtp_server 192.168.200.1
   <span class="token comment">#邮件服务器超时时间（暂不配置，默认即可）</span>
   smtp_connect_timeout 30
   <span class="token comment">#当前虚拟机的IP地址</span>
   router_id 192.168.206.128
<span class="token punctuation">}</span>

vrrp_script Monitor_Nginx <span class="token punctuation">{<!-- --></span>
 script <span class="token string">"/etc/keepalived/nginx_check.sh"</span>    <span class="token comment">#检测脚本执行的路径</span>
 interval 2                                 <span class="token comment">#检测脚本执行的间隔</span>
 weight 2                                   <span class="token comment">#检测脚本执行的权重</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER         <span class="token comment">#标识这个机器是MASTER还是BACKUP</span>
    interface eth0       <span class="token comment">#当前机器的网卡名称  </span>
    virtual_router_id 51 <span class="token comment">#虚拟路由的编号，主备必须一致</span>
    priority 100         <span class="token comment">#主、备机取不同的优先级，主机值较大，备份机值较小</span>
    advert_int 1         <span class="token comment">#(VRRP Multicast广播周期秒数)</span>
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS   <span class="token comment">#(VRRP认证方式)</span>
        auth_pass 1111   <span class="token comment">#(密码)</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{<!-- --></span>
		Monitor_Nginx <span class="token comment">#(调用nginx进程检测脚本)</span>
	<span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        192.168.206.50  <span class="token comment">#虚拟IP地址</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li><li style="color: rgb(153, 153, 153);">34</li><li style="color: rgb(153, 153, 153);">35</li><li style="color: rgb(153, 153, 153);">36</li><li style="color: rgb(153, 153, 153);">37</li><li style="color: rgb(153, 153, 153);">38</li><li style="color: rgb(153, 153, 153);">39</li><li style="color: rgb(153, 153, 153);">40</li></ul></pre> 
<p>新增keepalived的检测脚本：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/nginx_check.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"nginx: master process"</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token variable">)</span></span>"</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">]</span>
 <span class="token keyword">then</span>
 <span class="token function">killall</span> keepalived
<span class="token keyword">fi</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>启动keepalived服务：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># service keepalived start</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第四步：准备一台全新的虚拟机，安装nginx和keepalived</strong></p> 
<p>启动虚拟机：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkxODQ1MjAucG5n?x-oss-process=image/format,png" alt="image-20200829184513675"></p> 
<p>安装Nginx依赖：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># yum install -y gcc gcc-c++ make libtool wget pcre pcre-devel zlib zlib-devel openssl openssl-devel</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>下载Nginx文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># wget http://nginx.org/download/nginx-1.18.0.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>安装Nginx程序：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf nginx-1.18.0.tar.gz</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># cd nginx-1.18.0</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># ./configure</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># cd ~</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>开放Nginx防火墙：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
iptables：将防火墙规则保存到 /etc/sysconfig/iptables：     <span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>修改Nginx的配置：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">    upstream myserver <span class="token punctuation">{<!-- --></span>
        server 192.168.206.128:8080<span class="token punctuation">;</span>
        server 192.168.206.128:8081<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  192.168.206.128<span class="token punctuation">;</span>

        <span class="token comment">#charset koi8-r;</span>

        <span class="token comment">#access_log  logs/host.access.log  main;</span>

        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass http://myserver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li></ul></pre> 
<p>启动Nginx的服务：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>安装keepalived：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># yum install -y keepalived</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>删除keepalived的配置文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># rm -f /etc/keepalived/keepalived.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>新增keepalived的配置文件：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<blockquote> 
 <p>注意：一定要注意router_id、state、interface的值，我就在这里踩坑了</p> 
</blockquote> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived

global_defs <span class="token punctuation">{<!-- --></span>
   notification_email <span class="token punctuation">{<!-- --></span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   <span class="token comment">#邮件服务器通知地址（暂不配置，默认即可）</span>
   smtp_server 192.168.200.1
   <span class="token comment">#邮件服务器超时时间（暂不配置，默认即可）</span>
   smtp_connect_timeout 30
   <span class="token comment">#当前虚拟机的IP地址</span>
   router_id 192.168.206.129
<span class="token punctuation">}</span>

vrrp_script Monitor_Nginx <span class="token punctuation">{<!-- --></span>
 script <span class="token string">"/etc/keepalived/nginx_check.sh"</span>    <span class="token comment">#检测脚本执行的路径</span>
 interval 2                                 <span class="token comment">#检测脚本执行的间隔</span>
 weight 2                                   <span class="token comment">#检测脚本执行的权重</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state BACKUP         <span class="token comment">#标识这个机器是MASTER还是BACKUP</span>
    interface eth1       <span class="token comment">#当前机器的网卡名称  </span>
    virtual_router_id 51 <span class="token comment">#虚拟路由的编号，主备必须一致</span>
    priority 10          <span class="token comment">#主、备机取不同的优先级，主机值较大，备份机值较小</span>
    advert_int 1         <span class="token comment">#(VRRP Multicast广播周期秒数)</span>
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS   <span class="token comment">#(VRRP认证方式)</span>
        auth_pass 1111   <span class="token comment">#(密码)</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{<!-- --></span>
		Monitor_Nginx    <span class="token comment">#(调用nginx进程检测脚本)</span>
	<span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        192.168.206.50   <span class="token comment">#虚拟IP地址</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li><li style="color: rgb(153, 153, 153);">34</li><li style="color: rgb(153, 153, 153);">35</li><li style="color: rgb(153, 153, 153);">36</li><li style="color: rgb(153, 153, 153);">37</li><li style="color: rgb(153, 153, 153);">38</li><li style="color: rgb(153, 153, 153);">39</li><li style="color: rgb(153, 153, 153);">40</li></ul></pre> 
<p>新增keepalived的检测脚本：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/nginx_check.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"nginx: master process"</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token variable">)</span></span>"</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">]</span>
 <span class="token keyword">then</span>
 <span class="token function">killall</span> keepalived
<span class="token keyword">fi</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>启动keepalived服务：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># service keepalived start</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第五步：测试两个Nginx是否能正确的将请求分发到不同的Tomcat（负载均衡）</strong></p> 
<p>打开IE浏览器输入：http://192.168.206.128/edu/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE1MzMucG5n?x-oss-process=image/format,png" alt="image-20200829201531575"></p> 
<p>按住F5多刷新两遍，看看会不会，将请求转发到Tomcat2中去</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE1NDYucG5n?x-oss-process=image/format,png" alt="image-20200829201545343"></p> 
<hr> 
<p>打开IE浏览器输入：http://192.168.206.129/edu/a.html</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE2MjcucG5n?x-oss-process=image/format,png" alt="image-20200829201624282"></p> 
<p>按住F5多刷新两遍，看看会不会，将请求转发到Tomcat2中去</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE2NDQucG5n?x-oss-process=image/format,png" alt="image-20200829201643235"></p> 
<hr> 
<p>打开IE浏览器输入：http://192.168.206.50/edu/a.html，测试虚拟IP能不能实现负载均衡</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE4NTUucG5n?x-oss-process=image/format,png" alt="image-20200829201853743"></p> 
<p>按住F5多刷新两遍，看看会不会，将请求转发到Tomcat2中去</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE5MDgucG5n?x-oss-process=image/format,png" alt="image-20200829201906573"></p> 
<hr> 
<p>经过测试，我们发现一主一从、虚拟IP都能正常的进行负载均衡，接下来我们测试主节点挂掉，从节点会不会自动顶上，打开主节点机器，查看相关进程，杀死Nginx，然后打开浏览器，输入配置的虚拟IP地址：http://192.168.206.50/edu/a.html，发现负载均衡的效果还在，说明配置成功了</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE4NTUucG5n?x-oss-process=image/format,png" alt="image-20200829201853743"></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMDE5MDgucG5n?x-oss-process=image/format,png" alt="image-20200829201906573"></p> 
<h3><a name="t37"></a><a name="t37"></a><a id="65_950"></a>6.5、关闭服务</h3> 
<p>主机节点</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># service keepalived stop</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/shutdown.sh</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li></ul></pre> 
<p>备份节点</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># service keepalived stop</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<h2><a name="t38"></a><a name="t38"></a><a id="_Nginx_968"></a>第七章 Nginx配置详解</h2> 
<p>Nginx是通过配置文件来做到各个功能的实现的。Nginx的配置文件的格式非常合乎逻辑，学习这种格式以及如何使用这种每个部分是基础，这将帮助我们有可能手工创建一个配置文件。</p> 
<h3><a name="t39"></a><a name="t39"></a><a id="71_972"></a>7.1、整体结构图</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMTQwNDEucG5n?x-oss-process=image/format,png" alt="image-20200829214038483"></p> 
<h3><a name="t40"></a><a name="t40"></a><a id="72_976"></a>7.2、配置演示图</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMTQ0MDEucG5n?x-oss-process=image/format,png" alt="image-20200829214359553"></p> 
<h3><a name="t41"></a><a name="t41"></a><a id="73_980"></a>7.3、全局块</h3> 
<p>配置影响nginx全局的指令。主要包括：</p> 
<ul><li>配置运行Nginx服务器用户（组）</li><li>worker process数</li><li>Nginx进程</li><li>PID存放路径错误日志的存放路径</li><li>一个nginx进程打开的最多文件描述符数目</li></ul> 
<p>例如：</p> 
<pre class="prettyprint"><code class="prism language-properties has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">#配置worker进程运行用户（和用户组），nobody也是一个linux用户，一般用于启动程序，没有密码
user nobody;
#user www www;

#配置工作进程数目，根据硬件调整，通常等于CPU数量或者2倍于CPU数量
worker_processes 1;

#配置全局错误日志及类型，[debug | info | notice | warn | error | crit]，默认是error
error_log logs/error.log;
#error_log logs/error.log notice;
#error_log logs/error.log info;

#配置进程pid文件
pid logs/nginx.pid;

#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。
worker_rlimit_nofile 65535;
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li></ul></pre> 
<h3><a name="t42"></a><a name="t42"></a><a id="74events_1012"></a>7.4、events块</h3> 
<p>配置影响nginx服务器或与用户的网络连接。主要包括：</p> 
<ul><li>事件驱动模型的选择</li><li>最大连接数的配置</li></ul> 
<p>例如：</p> 
<pre class="prettyprint"><code class="prism language-properties has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">#参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; 
#epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。
use epoll;

#单个进程最大连接数（最大连接数=连接数*进程数）
worker_connections 65535;
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li></ul></pre> 
<h3><a name="t43"></a><a name="t43"></a><a id="75http_1030"></a>7.5、http块</h3> 
<p>可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。主要包括：</p> 
<ul><li>定义MIMI-Type</li><li>自定义服务日志</li><li>允许sendfile方式传输文件</li><li>连接超时时间</li><li>单连接请求数上限</li></ul> 
<p>例如：</p> 
<pre class="prettyprint"><code class="prism language-properties has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">#常见的一些基础配置
include mime.types; #文件扩展名与文件类型映射表
default_type application/octet-stream; #默认文件类型
charset utf-8; #默认编码
server_names_hash_bucket_size 128; #服务器名字的hash表大小
client_header_buffer_size 32k; #上传文件大小限制
large_client_header_buffers 4 64k; #设定请求缓冲
client_max_body_size 8m; #设定请求缓冲
sendfile on; #开启高效文件传输模式，对于普通应用设为on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。
autoindex on; #开启目录列表访问，合适下载服务器，默认关闭。
tcp_nopush on; #防止网络阻塞
tcp_nodelay on; #防止网络阻塞
keepalive_timeout 120; #长连接超时时间，单位是秒

#FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。
fastcgi_connect_timeout 300;
fastcgi_send_timeout 300;
fastcgi_read_timeout 300;
fastcgi_buffer_size 64k;
fastcgi_buffers 4 64k;
fastcgi_busy_buffers_size 128k;
fastcgi_temp_file_write_size 128k;

#gzip模块设置
gzip on; #开启gzip压缩输出
gzip_min_length 1k; #最小压缩文件大小
gzip_buffers 4 16k; #压缩缓冲区
gzip_http_version 1.0; #压缩版本（默认1.1，前端如果是squid2.5请使用1.0）
gzip_comp_level 2; #压缩等级
gzip_types text/plain application/x-javascript text/css application/xml; #压缩类型
gzip_vary on; #增加响应头'Vary: Accept-Encoding'
limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li></ul></pre> 
<h3><a name="t44"></a><a name="t44"></a><a id="76server_1077"></a>7.6、server块</h3> 
<p>配置虚拟主机的相关参数，一个http中可以有多个server。主要包括：</p> 
<ul><li>配置网络监听</li><li>配置https服务</li><li>基于名称的虚拟主机配置</li><li>基于IP的虚拟主机配置</li></ul> 
<p>例如：</p> 
<pre class="prettyprint"><code class="prism language-properties has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">#虚拟主机的常见配置
server {
    listen       80; #配置监听端口
    server_name  localhost; #配置服务名
    charset utf-8; #配置字符集
    access_log  logs/host.access.log  main; #配置本虚拟主机的访问日志
    
    location / {
        root html; #root是配置服务器的默认网站根目录位置，默认为nginx安装主目录下的html目录
        index index.html index.htm; #配置首页文件的名称
    }
    
    error_page 404             /404.html; #配置404错误页面
    error_page 500 502 503 504 /50x.html; #配置50x错误页面
}

#配置https服务，安全的网络传输协议，加密传输，端口443
server {
    listen       443 ssl;
    server_name  localhost;

    ssl_certificate      cert.pem;
    ssl_certificate_key  cert.key;

    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;

    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    location / {
        root   html;
        index  index.html index.htm;
    }
}
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li><li style="color: rgb(153, 153, 153);">34</li><li style="color: rgb(153, 153, 153);">35</li></ul></pre> 
<h3><a name="t45"></a><a name="t45"></a><a id="77location_1126"></a>7.7、location块</h3> 
<p>配置请求的路由，以及各种页面的处理情况。主要包括：</p> 
<ul><li>请求根目录配置更改</li><li>网站默认首页配置</li><li>location的URI</li></ul> 
<p>例如：</p> 
<pre class="prettyprint"><code class="prism language-properties has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">root html; #root是配置服务器的默认网站根目录位置，默认为nginx安装主目录下的html目录
index index.html index.htm; #配置首页文件的名称

proxy_pass http://127.0.0.1:88; #反向代理的地址
proxy_redirect off; #是否开启重定向
#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header Host $host;
#以下是一些反向代理的配置，可选。
client_max_body_size 10m; #允许客户端请求的最大单文件字节数
client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数，
proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时)
proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时)
proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时)
proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小
proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的设置
proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）
proxy_temp_file_write_size 64k;  #设定缓存文件夹大小
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li></ul></pre> 
<p>location的URI：</p> 
<p>描述：该指令用于匹配URL</p> 
<p>语法：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjgyMjUxMDcucG5n?x-oss-process=image/format,png" alt="image-20200828225104660"></p> 
<p>通配符：</p> 
<ul><li>= ：用于不含正则表达式的 uri 前，要求请求字符串与 uri 严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</li><li>~ ：用于表示 uri 包含正则表达式，并且区分大小写。</li><li>~* ：用于表示 uri 包含正则表达式，并且不区分大小写。</li><li>^~ ：用于不含正则表达式的 uri 前，要求 Nginx 服务器找到标识 uri 和请求字符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location 块中的正则 uri 和请求字符串做匹配。</li></ul> 
<blockquote> 
 <p>注意：如果 uri 包含正则表达式，则
 必须要有 ~ 或者 ~* 标识。</p> 
</blockquote> 
<h2><a name="t46"></a><a name="t46"></a><a id="_Nginx_1175"></a>第八章 Nginx原理分析</h2> 
<h3><a name="t47"></a><a name="t47"></a><a id="81nginx_1177"></a>8.1、nginx的线程模型？</h3> 
<p>Nginx默认采用多进程工作方式，Nginx启动后，会运行一个master进程和多个worker进程。其中master充当整个进程组与用户的交互接口，同时对进程进行监护，管理worker进程来实现重启服务、平滑升级、更换日志文件、配置文件实时生效等功能。worker用来处理基本的网络事件，worker之间是平等的，他们共同竞争来处理来自客户端的请求。</p> 
<p>nginx的进程模型如图所示：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMTU1NDUucG5n?x-oss-process=image/format,png" alt="image-20200829215544325"></p> 
<h3><a name="t48"></a><a name="t48"></a><a id="82worker_1185"></a>8.2、worker的工作模式？</h3> 
<p>worker对于连接是采用争抢的模式，谁先抢到就先交给谁处理，如果想要重新更新配置，由于已经抢到任务的worker不会参与争抢，那些空闲的worker就会去争抢连接，拿到连接后会自动更新配置信息，当那些有任务的worker完成任务后，会自动更新配置，这样就实现了无缝热部署。由于每个worker是独立的进程，如果有其中的一个worker出现问题，并不会影响其它worker继续进行争抢，在实现请求的过程，不会造成服务中断，建议worker数和服务器的cpu数相等是最为适宜的。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA4MjkyMTU3MDQucG5n?x-oss-process=image/format,png" alt="image-20200829215703292"></p> 
<h3><a name="t49"></a><a name="t49"></a><a id="83worker_1191"></a>8.3、如何计算worker连接数？</h3> 
<ul><li>如果只访问nginx的静态资源，一个发送请求会占用了 woker 的 2 个连接数</li><li>而如果是作为反向代理服务器，一个发送请求会占用了 woker 的 4 个连接数</li></ul> 
<h3><a name="t50"></a><a name="t50"></a><a id="84_1196"></a>8.4、如何计算最大的并发数？</h3> 
<ul><li>如果只访问nginx的静态资源，最大并发数量应该是： worker_connections * worker_processes / 2</li><li>而如果是作为反向代理服务器，最大并发数量应该是：worker_connections * worker_processes / 4</li></ul>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;dest&quot;:&quot;https://caochenlei.blog.csdn.net/article/details/108300342&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-d7a94ec6ab.css" rel="stylesheet">
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-ba784fbaf8.css" rel="stylesheet">
        </div>