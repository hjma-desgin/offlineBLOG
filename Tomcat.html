<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-b5506197d8.css">
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p>
<div class="toc">
 <h3><a name="t0"></a><a name="t0"></a>目录</h3>
 <ul><li><ul><li><a href="#_Tomcat_4" target="_self">第一章 Tomcat概述</a></li><li><ul><li><a href="#11Tomcat_6" target="_self">1.1、Tomcat概述</a></li><li><a href="#12Tomcat_12" target="_self">1.2、Tomcat历史</a></li><li><a href="#13Tomcat_19" target="_self">1.3、Tomcat官网</a></li></ul>
   </li><li><a href="#_Tomcat_23" target="_self">第二章 Tomcat单实例安装</a></li><li><ul><li><a href="#21_25" target="_self">2.1、环境准备</a></li><li><a href="#22Tomcat_33" target="_self">2.2、Tomcat下载</a></li><li><a href="#23Tomcat_39" target="_self">2.3、Tomcat解压</a></li><li><a href="#24Tomcat_45" target="_self">2.4、Tomcat安装</a></li><li><a href="#25Tomcat_51" target="_self">2.5、Tomcat启动</a></li><li><a href="#26Tomcat_72" target="_self">2.6、Tomcat关闭</a></li></ul>
   </li><li><a href="#_Tomcat_78" target="_self">第三章 Tomcat配置文件详解</a></li><li><ul><li><a href="#31serverxml__80" target="_self">3.1、server.xml 详解</a></li><li><ul><li><a href="#311Server_84" target="_self">3.1.1、Server</a></li><li><a href="#312Listener_100" target="_self">3.1.2、Listener</a></li><li><a href="#313GlobalNamingResources_121" target="_self">3.1.3、GlobalNamingResources</a></li><li><a href="#314Service_137" target="_self">3.1.4、Service</a></li><li><a href="#315Executor_147" target="_self">3.1.5、Executor</a></li><li><a href="#316Connector_175" target="_self">3.1.6、Connector</a></li><li><a href="#317Engine_246" target="_self">3.1.7、Engine</a></li><li><a href="#318Host_261" target="_self">3.1.8、Host</a></li><li><a href="#319Context_292" target="_self">3.1.9、Context</a></li></ul>
    </li><li><a href="#32tomcatusersxml__321" target="_self">3.2、tomcat-users.xml 详解</a></li><li><ul><li><a href="#321hostmanager_327" target="_self">3.2.1、host-manager应用配置</a></li><li><a href="#322manager_346" target="_self">3.2.2、manager应用配置</a></li></ul>
    </li><li><a href="#33webxml__362" target="_self">3.3、web.xml 详解</a></li><li><ul><li><a href="#331ServletContext_366" target="_self">3.3.1、ServletContext初始化参数</a></li><li><a href="#332_384" target="_self">3.3.2、会话配置</a></li><li><a href="#333Servlet_417" target="_self">3.3.3、Servlet配置</a></li><li><a href="#334Listener_479" target="_self">3.3.4、Listener配置</a></li><li><a href="#335Filter_493" target="_self">3.3.5、Filter配置</a></li><li><a href="#336_529" target="_self">3.3.6、欢迎页面配置</a></li><li><a href="#337_544" target="_self">3.3.7、错误页面配置</a></li></ul>
   </li></ul>
   </li><li><a href="#_Tomcat_563" target="_self">第四章 Tomcat高可用集群</a></li><li><ul><li><a href="#41_565" target="_self">4.1、环境准备</a></li><li><a href="#42_573" target="_self">4.2、集群概述</a></li><li><a href="#43_577" target="_self">4.3、集群架构</a></li><li><a href="#44tomcat_581" target="_self">4.4、安装第一台tomcat服务器</a></li><li><a href="#45tomcat_615" target="_self">4.5、安装第二台tomcat服务器</a></li><li><a href="#46Nginx_699" target="_self">4.6、安装Nginx反向代理服务器</a></li><li><a href="#47_768" target="_self">4.7、访问测试</a></li><li><a href="#48nginx_778" target="_self">4.8、如何保证主nginx高可用</a></li><li><a href="#49session_784" target="_self">4.9、如何解决session共享问题</a></li></ul>
   </li><li><a href="#_Tomcat_808" target="_self">第五章 Tomcat安全问题</a></li><li><ul><li><a href="#51_810" target="_self">5.1、配置安全</a></li><li><a href="#52_818" target="_self">5.2、应用安全</a></li><li><a href="#53_822" target="_self">5.3、传输安全</a></li></ul>
   </li><li><a href="#_Tomcat_969" target="_self">第六章 Tomcat原理分析</a></li><li><ul><li><a href="#61Http_971" target="_self">6.1、Http工作原理</a></li><li><a href="#62Tomcat_993" target="_self">6.2、Tomcat整体架构</a></li><li><a href="#63Coyote_1004" target="_self">6.3、Coyote连接器架构</a></li><li><a href="#64Catalina_1059" target="_self">6.4、Catalina容器架构</a></li><li><a href="#65Jasper_1125" target="_self">6.5、Jasper处理流程</a></li><li><a href="#66JSP_1142" target="_self">6.6、JSP编译过程</a></li><li><a href="#67Tomcat_1167" target="_self">6.7、Tomcat启动流程</a></li><li><a href="#68Tomcat_1171" target="_self">6.8、Tomcat请求处理流程</a></li></ul>
  </li></ul>
 </li></ul>
</div>
<p></p> 
<hr> 
<h2><a name="t1"></a><a name="t1"></a><a id="_Tomcat_4"></a>第一章 Tomcat概述</h2> 
<h3><a name="t2"></a><a name="t2"></a><a id="11Tomcat_6"></a>1.1、Tomcat概述</h3> 
<p>Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。</p> 
<p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好Apache 服务器，可利用它响应HTML（标准通用标记语言下的一个应用）页面的访问请求。实际上Tomcat是Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行tomcat 时，它实际上作为一个与Apache 独立的进程单独运行的。</p> 
<h3><a name="t3"></a><a name="t3"></a><a id="12Tomcat_12"></a>1.2、Tomcat历史</h3> 
<ol><li>Tomcat 最初由Sun公司的软件架构师 James Duncan Davidson 开发，名称为“JavaWebServer”。</li><li>1999年，在 Davidson 的帮助下，该项目于1999年于apache软件基金会旗下的JServ项目合并，并发布第一个版本（3.x），即是现在的Tomcat，该版本实现了Servlet2.2和JSP 1.1规范 。</li><li>2001年，Tomcat 发布了4.0版本， 作为里程碑式的版本，Tomcat 完全重新设计了其架构，并实现了Servlet 2.3和JSP 1.2规范。</li><li>目前 Tomcat 已经更新到 10.0.x版本，但是目前企业中的Tomcat服务器，主流版本还是7.x 和 8.x，所以本课程是基于 8.5 版本进行讲解。</li></ol> 
<h3><a name="t4"></a><a name="t4"></a><a id="13Tomcat_19"></a>1.3、Tomcat官网</h3> 
<p><a href="http://tomcat.apache.org/">点击打开</a></p> 
<h2><a name="t5"></a><a name="t5"></a><a id="_Tomcat_23"></a>第二章 Tomcat单实例安装</h2> 
<h3><a name="t6"></a><a name="t6"></a><a id="21_25"></a>2.1、环境准备</h3> 
<ul><li>虚拟机的版本：VMware-workstation-full-15.5.6-16341506.exe</li><li>系统镜像版本：CentOS-6.10-x86_64-bin-DVD1.iso，全新安装，桌面版，可上网</li><li>系统内存大小：1GB</li><li>系统硬盘大小：20GB</li><li>连接工具版本：SecureCRTSecureFX_HH_x64_7.0.0.326.zip</li></ul> 
<h3><a name="t7"></a><a name="t7"></a><a id="22Tomcat_33"></a>2.2、Tomcat下载</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-8/v8.5.57/bin/apache-tomcat-8.5.57.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t8"></a><a name="t8"></a><a id="23Tomcat_39"></a>2.3、Tomcat解压</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-8.5.57.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t9"></a><a name="t9"></a><a id="24Tomcat_45"></a>2.4、Tomcat安装</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-8.5.57 /usr/local/tomcat</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t10"></a><a name="t10"></a><a id="25Tomcat_51"></a>2.5、Tomcat启动</h3> 
<blockquote> 
 <p>注意：Tomcat启动需要Java环境，我这里没有安装，使用的是系统自带的，如果你的系统没有Java环境请自行安装，Java环境安装不再本讲之中！</p> 
</blockquote> 
<p><strong>启动Tomcat：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>关闭防火墙：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># service iptables stop</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># chkconfig iptables off</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>**在浏览器输入：**http://192.168.239.144:8080/</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYxNTUzMDcucG5n?x-oss-process=image/format,png" alt="image-20200906155005379"></p> 
<h3><a name="t11"></a><a name="t11"></a><a id="26Tomcat_72"></a>2.6、Tomcat关闭</h3> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/shutdown.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h2><a name="t12"></a><a name="t12"></a><a id="_Tomcat_78"></a>第三章 Tomcat配置文件详解</h2> 
<h3><a name="t13"></a><a name="t13"></a><a id="31serverxml__80"></a>3.1、server.xml 详解</h3> 
<p>server.xml 是tomcat 服务器的核心配置文件，包含了Tomcat的 Servlet 容器（Catalina）的所有配置。</p> 
<h4><a id="311Server_84"></a>3.1.1、Server</h4> 
<p>Server是server.xml的根元素，用于创建一个Server实例，默认使用的实现类是 org.apache.catalina.core.StandardServer。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>port：Tomcat 监听的关闭服务器的端口。</li><li>shutdown：关闭服务器的指令字符串。</li><li>Server内嵌的子元素为 Listener、GlobalNamingResources、Service。</li></ul> 
<h4><a id="312Listener_100"></a>3.1.2、Listener</h4> 
<p>默认配置的5个Listener的含义：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">用于以日志形式输出服务器</span> <span class="token attr-name">、操作系统、JVM的版本信息</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.startup.VersionLoggerListener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">用于加载（服务器启动）</span> <span class="token attr-name">和</span> <span class="token attr-name">销毁</span> <span class="token attr-name">（服务器停止）</span> <span class="token attr-name">APR。</span> <span class="token attr-name">如果找不到APR库，</span> <span class="token attr-name">则会输出日志，</span> <span class="token attr-name">并不影响Tomcat启动</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.AprLifecycleListener<span class="token punctuation">"</span></span> <span class="token attr-name">SSLEngine</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">用于避免JRE内存泄漏问题</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.JreMemoryLeakPreventionListener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">用户加载（服务器启动）</span> <span class="token attr-name">和</span> <span class="token attr-name">销毁（服务器停止）</span> <span class="token attr-name">全局命名服务</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.mbeans.GlobalResourcesLifecycleListener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">用于在Context停止时重建Executor</span> <span class="token attr-name">池中的线程，</span> <span class="token attr-name">以避免ThreadLocal</span> <span class="token attr-name">相关的内存泄漏</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.ThreadLocalLeakPreventionListener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li></ul></pre> 
<h4><a id="313GlobalNamingResources_121"></a>3.1.3、GlobalNamingResources</h4> 
<p>GlobalNamingResources中定义了全局命名服务：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GlobalNamingResources</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!‐‐</span> <span class="token attr-name">可编辑的用户数据库，UserDatabaseRealm也可以使用该数据库对用户进行身份验证</span> <span class="token attr-name">‐‐</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Resource</span> 	<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span> 
				<span class="token attr-name">auth</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Container<span class="token punctuation">"</span></span> 
				<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.UserDatabase<span class="token punctuation">"</span></span> 
				<span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User database that can be updated and saved<span class="token punctuation">"</span></span> 
				<span class="token attr-name">factory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.users.MemoryUserDatabaseFactory<span class="token punctuation">"</span></span> 
				<span class="token attr-name">pathname</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>conf/tomcat‐users.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GlobalNamingResources</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li></ul></pre> 
<h4><a id="314Service_137"></a>3.1.4、Service</h4> 
<p>该元素用于创建 Service 实例，默认使用 org.apache.catalina.core.StandardService。默认情况下，Tomcat 仅指定了Service 的名称， 值为 “Catalina”。Service 可以内嵌的元素为 ： Listener、Executor、Connector、Engine，其中 ： Listener 用于为Service添加生命周期监听器， Executor 用于配置Service 共享线程池，Connector 用于配置Service 包含的链接器， Engine 用于配置Service中链接器对应的Servlet 容器引擎。一个Server服务器，可以包含多个Service服务。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<h4><a id="315Executor_147"></a>3.1.5、Executor</h4> 
<p>默认情况下，Service 并未添加共享线程池配置。 如果我们想添加一个线程池， 可以在 下添加如下配置：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Executor</span>   <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tomcatThreadPool<span class="token punctuation">"</span></span> 
			<span class="token attr-name">namePrefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>catalina‐exec‐<span class="token punctuation">"</span></span> 
			<span class="token attr-name">maxThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span> 
			<span class="token attr-name">minSpareThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> 
			<span class="token attr-name">maxIdleTime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span> 
			<span class="token attr-name">maxQueueSize</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer.MAX_VALUE<span class="token punctuation">"</span></span> 
			<span class="token attr-name">prestartminSpareThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> 
			<span class="token attr-name">threadPriority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>
			<span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.core.StandardThreadExecutor<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>name：线程池名称，用于Connector中指定。</li><li>namePrefix：所创建的每个线程的名称前缀，一个单独的线程名称为 namePrefix+threadNumber。</li><li>maxThreads：池中最大线程数。</li><li>minSpareThreads：活跃线程数，也就是核心池线程数，这些线程不会被销毁，会一直存在。</li><li>maxIdleTime：线程空闲时间，超过该时间后，空闲线程会被销毁，默认值为6000（1分钟），单位毫秒。</li><li>maxQueueSize：在被执行前最大线程排队数目，默认为Int的最大值，也就是广义的无限。除非特殊情况，这个值不需要更改， 否则会有请求不会被处理的情况发生。</li><li>prestartminSpareThreads：启动线程池时是否启动 minSpareThreads部分线程。 默认值为false，即不启动。</li><li>threadPriority：线程池中线程优先级，默认值为5，值从1到10。</li><li>className：线程池实现类，未指定情况下，默认实现类为 org.apache.catalina.core.StandardThreadExecutor。 如果想使用自定义线程池首先需要实现 org.apache.catalina.Executor接口。</li></ul> 
<h4><a id="316Connector_175"></a>3.1.6、Connector</h4> 
<p>Connector 用于创建链接器实例。默认情况下，server.xml 配置了两个链接器，一个支持HTTP协议，一个支持AJP协议。因此大多数情况下，我们并不需要新增链接器配置， 只是根据需要对已有链接器进行优化。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li> <p>port：端口号，Connector 用于创建服务端Socket 并进行监听， 以等待客户端请求链接。如果该属性设置为0，Tomcat将会随机选择一个可用的端口号给当前Connector使用。</p> </li><li> <p>protocol：当前Connector 支持的访问协议。 默认为 HTTP/1.1，并采用自动切换机制选择一个基于 JAVA NIO 的链接器或者基于本地APR的链接器（根据本地是否含有Tomcat的本地库判定）。如果不希望采用上述自动切换的机制， 而是明确指定协议， 可以使用以下值。</p> 
  <ul><li>Http协议：</li></ul> <pre class="prettyprint"><code class="has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">org.apache.coyote.http11.Http11NioProtocol  ，非阻塞式 Java NIO 链接器
org.apache.coyote.http11.Http11Nio2Protocol ，非阻塞式 JAVA NIO2 链接器
org.apache.coyote.http11.Http11AprProtocol  ，APR 链接器
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
  <ul><li>AJP协议：</li></ul> <pre class="prettyprint"><code class="has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">org.apache.coyote.ajp.AjpNioProtocol  ，非阻塞式 Java NIO 链接器
org.apache.coyote.ajp.AjpNio2Protocol ，非阻塞式 JAVA NIO2 链接器
org.apache.coyote.ajp.AjpAprProtocol  ，APR 链接器
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> </li><li> <p>connectionTimeout：Connector接收连接后的等待超时时间， 单位为毫秒。 -1 表示不超时。</p> </li><li> <p>redirectPort：当前Connector 不支持SSL请求， 接收到了一个请求， 并且也符合 security-constraint 约束， 需要SSL传输，Catalina自动将请求重定向到指定的端口。</p> </li><li> <p>executor：指定共享线程池的名称， 也可以通过maxThreads、minSpareThreads 等属性配置内部线程池。</p> </li><li> <p>URIEncoding：用于指定编码URI的字符编码， Tomcat8.x版本默认的编码为UTF-8 , Tomcat7.x版本默认为ISO-8859-1。</p> </li><li> <p>maxThreads：池中最大线程数。</p> </li><li> <p>minSpareThreads：活跃线程数，也就是核心池线程数，这些线程不会被销毁，会一直存在。</p> </li><li> <p>acceptCount：接收的连接数。</p> </li><li> <p>maxConnections：接收的最大连接数。</p> </li><li> <p>compression：是否压缩。</p> </li><li> <p>compressionMinSize：压缩的大小。</p> </li><li> <p>disableUploadTimeout：禁用上传超时。</p> </li></ul> 
<p>完整的配置如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span>  <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> 
			<span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> 
			<span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> 
			<span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> 
			<span class="token attr-name">executor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tomcatThreadPool<span class="token punctuation">"</span></span> 
			<span class="token attr-name">URIEncoding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF‐8<span class="token punctuation">"</span></span>
			<span class="token attr-name">maxThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> 
			<span class="token attr-name">minSpareThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> 
			<span class="token attr-name">acceptCount</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> 
			<span class="token attr-name">maxConnections</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> 
			<span class="token attr-name">compression</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> 
			<span class="token attr-name">compressionMinSize</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2048<span class="token punctuation">"</span></span>
			<span class="token attr-name">disableUploadTimeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li></ul></pre> 
<h4><a id="317Engine_246"></a>3.1.7、Engine</h4> 
<p>Engine 作为Servlet 引擎的顶级元素，内部可以嵌入： Cluster、Listener、Realm、 Valve和Host。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>name： 用于指定Engine的名称， 默认为Catalina 。该名称会影响一部分Tomcat的存储路径（如临时文件）。</li><li>defaultHost ： 默认使用的虚拟主机名称， 当客户端请求指向的主机无效时， 将交由默认的虚拟主机处理， 默认为localhost。</li></ul> 
<h4><a id="318Host_261"></a>3.1.8、Host</h4> 
<p>Host 元素用于配置一个虚拟主机， 它支持以下嵌入元素：Alias、Cluster、Listener、Valve、Realm、Context。</p> 
<p>如果在Engine下配置Realm， 那么此配置将在当前Engine下的所有Host中共享。 同样，如果在Host中配置Realm ， 则在当前Host下的所有Context中共享。</p> 
<p>Context中的Realm优先级 &gt; Host 的Realm优先级 &gt; Engine中的Realm优先级。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>name：当前Host通用的网络名称，必须与DNS服务器上的注册信息一致。 Engine中包含的Host必须存在一个名称与Engine的defaultHost设置一致。</li><li>appBase：当前Host的应用基础目录，当前Host上部署的Web应用均在该目录下（可以是绝对目录，相对路径），默认为webapps。</li><li>unpackWARs：设置为true，Host在启动时会将appBase目录下war包解压为目录。设置为false， Host将直接从war文件启动。</li><li>autoDeploy：控制tomcat是否在运行时定期检测并自动部署新增或变更的web应用。</li></ul> 
<p>通过给Host添加别名，我们可以实现同一个Host拥有多个网络名称，配置如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>www.web1.com<span class="token punctuation">"</span></span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Alias</span><span class="token punctuation">&gt;</span></span>www.web2.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Alias</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>这个时候，我们就可以通过两个域名访问当前Host下的应用（需要确保DNS或hosts中添加了域名的映射配置）。</p> 
<h4><a id="319Context_292"></a>3.1.9、Context</h4> 
<p>Context 用于配置一个Web应用，默认的配置如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myApp<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/myApp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	....
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>docBase：Web应用目录或者War包的部署路径。可以是绝对路径，也可以是相对于Host appBase的相对路径。</li><li>path：Web应用的Context 路径。如果我们Host名为localhost， 则该web应用访问的根路径为： http://localhost:8080/myApp。</li><li>它支持的内嵌元素为：CookieProcessor， Loader， Manager，Realm，Resources，WatchedResource，JarScanner，Valve。</li></ul> 
<p>简单的举例：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>www.tomcat.com<span class="token punctuation">"</span></span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>D:\servlet_project<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/myApp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span>  <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.valves.AccessLogValve<span class="token punctuation">"</span></span> 
			<span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> 
			<span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost_access_log<span class="token punctuation">"</span></span> 
			<span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.txt<span class="token punctuation">"</span></span> 
			<span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%h %l %u %t <span class="token entity" title="&quot;">&amp;quot;</span>%r<span class="token entity" title="&quot;">&amp;quot;</span> %s %b<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li></ul></pre> 
<h3><a name="t14"></a><a name="t14"></a><a id="32tomcatusersxml__321"></a>3.2、tomcat-users.xml 详解</h3> 
<p>该配置文件中，主要配置的是Tomcat的用户，角色等信息，用来控制Tomcat中 host-manager、manager的访问权限。</p> 
<p>从早期的Tomcat版本开始，就提供了Web版的管理控制台，他们是两个独立的Web应用，位于webapps目录下。Tomcat 提供的管理应用有用于管理的Host的host-manager 和用于管理Web应用的manager。</p> 
<h4><a id="321hostmanager_327"></a>3.2.1、host-manager应用配置</h4> 
<p>Tomcat启动之后，可以通过 http://localhost:8080/host-manager/html 访问该Web应用。 host-manager 默认添加了访问权限控制，当打开网址时，需要输入用户名和密码（conf/tomcat-users.xml中配置） 。所以要想访问该页面，需要在conf/tomcat-users.xml 中配置，并分配对应的角色：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin-gui<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin-script<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token attr-name">roles</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin-gui,admin-script<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>admin-gui：用于控制页面访问权限。</li><li>admin-script：用于控制以简单文本的形式进行访问。</li></ul> 
<p>启动Tomcat，然后点击host-manager，我是在虚拟机的火狐浏览器中打开的，它不能让别人随意访问，否则会出现安全问题：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYxNzI5NTAucG5n?x-oss-process=image/format,png" alt="image-20200906172949187"></p> 
<h4><a id="322manager_346"></a>3.2.2、manager应用配置</h4> 
<p>manager的访问地址为 http://localhost:8080/manager，同样，manager也添加了页面访问控制，所以要想访问该页面，需要在conf/tomcat-users.xml 中配置，并分配对应的角色：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin‐gui<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin‐script<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>manager‐gui<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>manager‐script<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token attr-name">roles</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>admin-script,admin-gui,manager-gui,manager-script<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>启动Tomcat，然后点击manager，我是在虚拟机的火狐浏览器中打开的，它不能让别人随意访问，否则会出现安全问题：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYxNzM0MTEucG5n?x-oss-process=image/format,png" alt="image-20200906173409876"></p> 
<h3><a name="t15"></a><a name="t15"></a><a id="33webxml__362"></a>3.3、web.xml 详解</h3> 
<p>web.xml 是web应用的描述文件， 它支持的元素及属性来自于Servlet 规范定义 。 在Tomcat 中， Web 应用的描述信息包括 tomcat/conf/web.xml 中默认配置以及 Web应用 WEB-INF/web.xml 下的定制配置。</p> 
<h4><a id="331ServletContext_366"></a>3.3.1、ServletContext初始化参数</h4> 
<p>我们可以通过 添加ServletContext 初始化参数，它配置了一个键值对，这样我们可以在应用程序中使用 javax.servlet.ServletContext.getInitParameter()方法获取参数。举例如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context‐param</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param‐name</span><span class="token punctuation">&gt;</span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param‐value</span><span class="token punctuation">&gt;</span></span>classpath:applicationContext‐*.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Spring Config File Location<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context‐param</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>param‐name：初始化参数名称。</li><li>param‐value：初始化参数的值。</li><li>description：这个参数的描述信息。</li></ul> 
<h4><a id="332_384"></a>3.3.2、会话配置</h4> 
<p>用于配置Web应用会话，包括 超时时间、Cookie配置以及会话追踪模式。它将覆盖server.xml 和 context.xml 中的配置。举例如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-config</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-timeout</span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session‐timeout</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cookie-config</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>JESSIONID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span><span class="token punctuation">&gt;</span></span>www.baidu.cn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>Session Cookie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>http-only</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>http‐only</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>secure</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>secure</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max-age</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max‐age</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cookie‐config</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tracking-mode</span><span class="token punctuation">&gt;</span></span>COOKIE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tracking‐mode</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session‐config</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>session-timeout： 会话超时时间，单位：分钟。</li><li>cookie-config：用于配置会话追踪Cookie。 
  <ul><li>name：Cookie的名称。</li><li>domain：Cookie的域名。</li><li>path：Cookie的路径。</li><li>comment：Cookie的注释。</li><li>http-only：Cookie只能通过HTTP方式进行访问，JS无法读取或修改，此项可以增 加网站访问的安全性。</li><li>secure：此Cookie只能通过HTTPS连接传递到服务器，而HTTP连接则不会传递该信息。注意是从浏览器传递到服务器，服务器端的Cookie对象不受此项影响。</li><li>max-age：以秒为单位表示cookie的生存期，默认为‐1表示是会话Cookie，浏览器 关闭时就会消失。</li></ul> </li><li>tracking-mode：用于配置会话追踪模式，Servlet3.0版本中支持的追踪模式： COOKIE、URL、SSL。</li></ul> 
<h4><a id="333Servlet_417"></a>3.3.3、Servlet配置</h4> 
<p>Servlet 的配置主要是两部分， servlet 和 servlet-mapping ：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>myServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>com.caochenlei.MyServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐class</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>fileName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>init.conf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init‐param</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load‐on‐startup</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>myServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url‐pattern</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/myservet/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url‐pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐mapping</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li></ul></pre> 
<p>标签属性和子元素：</p> 
<p>servlet：</p> 
<ul><li>servlet-name：指定servlet的名称， 该属性在web.xml中唯一。</li><li>servlet-class：用于指定servlet类名。</li><li>init-param：用于指定servlet的初始化参数， 在应用中可以通过 HttpServlet.getInitParameter 获取。 
  <ul><li>param-name：初始化参数名称。</li><li>param-value：初始化参数的值。</li></ul> </li><li>load-on-startup：用于控制在Web应用启动时，Servlet的加载顺序， 值小于0，web应用启动时，不加载该servlet，第一次访问时加载。</li><li>enabled：若为false，表示Servlet不处理任何请求。</li></ul> 
<p>servlet-mapping：</p> 
<ul><li>servlet-name：你想要让哪个servlet处理，这里就写哪个servlet名称。</li><li>url-pattern：用于指定URL表达式，一个 servlet‐mapping可以同时配置多个 url‐ pattern。</li></ul> 
<p>servlet 中文件上传配置：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>uploadServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>com.caochenlei.UploadServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet‐class</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>multipart-config</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>C://path<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max-file-size</span><span class="token punctuation">&gt;</span></span>10485760<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max‐file‐size</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max-request-size</span><span class="token punctuation">&gt;</span></span>10485760<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max‐request‐size</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file-size-threshold</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file‐size‐threshold</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>multipart‐config</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>multipart-config：上传的配置 
  <ul><li>location：存放生成的文件地址。</li><li>max-file-size：允许上传的文件最大值。 默认值为‐1， 表示没有限制。</li><li>max-request-size：针对该 multi/form‐data 请求的最大数量，默认值为‐1， 表示无限制。</li><li>file-size-threshold：当数量量大于该值时， 内容会被写入文件。</li></ul> </li></ul> 
<h4><a id="334Listener_479"></a>3.3.4、Listener配置</h4> 
<p>Listener用于监听servlet中的事件，例如context、request、session对象的创建、修改、删除，并触发响应事件。Listener是观察者模式的实现，在servlet中主要用于对context、request、session对象的生命周期进行监控。在servlet2.5规范中共定义了8中Listener。在启动时，ServletContextListener 的执行顺序与web.xml 中的配置顺序一致， 停止时执行顺序相反。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.context.ContextLoaderListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener‐class</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<p>标签属性和子元素：</p> 
<ul><li>listener-class：用于指定监听的类，该类必须实现Listener接口。</li></ul> 
<h4><a id="335Filter_493"></a>3.3.5、Filter配置</h4> 
<p>filter 用于配置web应用过滤器， 用来过滤资源请求及响应。 经常用于认证、日志、加密、数据转换等操作， 配置如下：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>myFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>com.caochenlei.MyFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter‐class</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>async-supported</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>async‐supported</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>language<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>CN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param‐value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init‐param</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>myFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter‐name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url‐pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter‐mapping</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li></ul></pre> 
<p>标签属性和子元素：</p> 
<p>filter：</p> 
<ul><li>filter-name：用于指定过滤器名称，在web.xml中，过滤器名称必须唯一。</li><li>filter-class：过滤器的全限定类名，该类必须实现Filter接口。</li><li>async-supported：该过滤器是否支持异步。</li><li>init-param：用于配置Filter的初始化参数， 可以配置多个， 可以通过FilterConfig.getInitParameter获取。 
  <ul><li>param-name：初始化参数名称。</li><li>param-value：初始化参数的值。</li></ul> </li></ul> 
<p>filter-mapping：</p> 
<ul><li>filter-name：这里指的是你想使用哪个过滤器进行过滤就写哪个过滤器的名称。</li><li>url-pattern：指定该过滤器需要拦截的URL。</li></ul> 
<h4><a id="336_529"></a>3.3.6、欢迎页面配置</h4> 
<p>welcome-file-list 用于指定web应用的欢迎文件列表。尝试请求的顺序，从上到下。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>index.htm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>index.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>default.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>default.htm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>default.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li></ul></pre> 
<h4><a id="337_544"></a>3.3.7、错误页面配置</h4> 
<p>error-page 用于配置Web应用访问异常时定向到的页面，支持HTTP响应码和异常类两种形式。</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-page</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-code</span><span class="token punctuation">&gt;</span></span>404<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error‐code</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/404.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error‐page</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-page</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-code</span><span class="token punctuation">&gt;</span></span>500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error‐code</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/500.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error‐page</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-page</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exception-type</span><span class="token punctuation">&gt;</span></span>java.lang.Exception<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exception‐type</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/error.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error‐page</span><span class="token punctuation">&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li></ul></pre> 
<h2><a name="t16"></a><a name="t16"></a><a id="_Tomcat_563"></a>第四章 Tomcat高可用集群</h2> 
<h3><a name="t17"></a><a name="t17"></a><a id="41_565"></a>4.1、环境准备</h3> 
<ul><li>虚拟机的版本：VMware-workstation-full-15.5.6-16341506.exe</li><li>系统镜像版本：CentOS-6.10-x86_64-bin-DVD1.iso，全新安装，桌面版，可上网</li><li>系统内存大小：1GB</li><li>系统硬盘大小：20GB</li><li>连接工具版本：SecureCRTSecureFX_HH_x64_7.0.0.326.zip</li></ul> 
<h3><a name="t18"></a><a name="t18"></a><a id="42_573"></a>4.2、集群概述</h3> 
<p>由于单台Tomcat的承载能力是有限的，当我们的业务系统用户量比较大，请求压力比较大时，单台Tomcat是扛不住的，这个时候，就需要搭建Tomcat的集群，而目前比较流程的做法就是通过Nginx来实现Tomcat集群的负载均衡。</p> 
<h3><a name="t19"></a><a name="t19"></a><a id="43_577"></a>4.3、集群架构</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYxODE0MjYucG5n?x-oss-process=image/format,png" alt="image-20200906181424604"></p> 
<h3><a name="t20"></a><a name="t20"></a><a id="44tomcat_581"></a>4.4、安装第一台tomcat服务器</h3> 
<p>解压：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-8.5.57.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>安装：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-8.5.57 /usr/local/tomcat1</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>创建测试目录和页面：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat1/webapps/edu</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;This is 8080 Port&lt;/h1&gt;" &gt; /usr/local/tomcat1/webapps/edu/a.html</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>开放防火墙：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 8080 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>启动：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t21"></a><a name="t21"></a><a id="45tomcat_615"></a>4.5、安装第二台tomcat服务器</h3> 
<p>解压：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf apache-tomcat-8.5.57.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>安装：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mv apache-tomcat-8.5.57 /usr/local/tomcat2</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>修改端口：</p> 
<ul><li>先删除：</li></ul> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># rm -f /usr/local/tomcat2/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<ul><li>再添加：</li></ul> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/tomcat2/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Server port<span class="token operator">=</span><span class="token string">"8015"</span> shutdown<span class="token operator">=</span><span class="token string">"SHUTDOWN"</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.startup.VersionLoggerListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.AprLifecycleListener"</span> SSLEngine<span class="token operator">=</span><span class="token string">"on"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /<span class="token operator">&gt;</span>

	<span class="token operator">&lt;</span>GlobalNamingResources<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Resource   name<span class="token operator">=</span><span class="token string">"UserDatabase"</span> 
					auth<span class="token operator">=</span><span class="token string">"Container"</span> 
					type<span class="token operator">=</span><span class="token string">"org.apache.catalina.UserDatabase"</span> 
					description<span class="token operator">=</span><span class="token string">"User database that can be updated and saved"</span> 
					factory<span class="token operator">=</span><span class="token string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span> 
					pathname<span class="token operator">=</span><span class="token string">"conf/tomcat-users.xml"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/GlobalNamingResources<span class="token operator">&gt;</span>

	<span class="token operator">&lt;</span>Service name<span class="token operator">=</span><span class="token string">"Catalina"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Connector port<span class="token operator">=</span><span class="token string">"8081"</span> protocol<span class="token operator">=</span><span class="token string">"HTTP/1.1"</span> connectionTimeout<span class="token operator">=</span><span class="token string">"20000"</span> redirectPort<span class="token operator">=</span><span class="token string">"8443"</span> /<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Engine name<span class="token operator">=</span><span class="token string">"Catalina"</span> defaultHost<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.LockOutRealm"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.UserDatabaseRealm"</span> resourceName<span class="token operator">=</span><span class="token string">"UserDatabase"</span> /<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/Realm<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>Host name<span class="token operator">=</span><span class="token string">"localhost"</span> appBase<span class="token operator">=</span><span class="token string">"webapps"</span> unpackWARs<span class="token operator">=</span><span class="token string">"true"</span> autoDeploy<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>Valve  className<span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> 
						directory<span class="token operator">=</span><span class="token string">"logs"</span> 
						prefix<span class="token operator">=</span><span class="token string">"localhost_access_log"</span> 
						suffix<span class="token operator">=</span><span class="token string">".txt"</span> 
						pattern<span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/Host<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/Engine<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/Service<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/Server<span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li></ul></pre> 
<p>创建测试目录和页面：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /usr/local/tomcat2/webapps/edu</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># echo "&lt;h1&gt;This is 8081 Port&lt;/h1&gt;" &gt; /usr/local/tomcat2/webapps/edu/a.html </span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>开放防火墙：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 8081 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>启动：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h3><a name="t22"></a><a name="t22"></a><a id="46Nginx_699"></a>4.6、安装Nginx反向代理服务器</h3> 
<p><strong>安装依赖：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># yum install -y gcc gcc-c++ make libtool wget pcre pcre-devel zlib zlib-devel openssl openssl-devel</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>Nginx下载：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># wget http://nginx.org/download/nginx-1.18.0.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>Nginx解压：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf nginx-1.18.0.tar.gz</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>Nginx安装：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># cd nginx-1.18.0</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># ./configure</span>
<span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<blockquote> 
 <p>注意：安装完成后的路径为：/usr/local/nginx</p> 
</blockquote> 
<p><strong>Nginx配置：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/nginx/conf/nginx.conf</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token comment">#在 server 外边配置，负载均衡服务列表</span>
upstream myserver <span class="token punctuation">{<!-- --></span>
	server 192.168.239.144:8080<span class="token punctuation">;</span>
	server 192.168.239.144:8081<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#在 location / { 里边配置，路径请求转发规则</span>
	proxy_pass http://myserver<span class="token punctuation">;</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>Nginx命令：</strong></p> 
<ul><li>普通启动服务：/usr/local/nginx/sbin/nginx</li><li>配置文件启动：/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</li><li>暴力停止服务：/usr/local/nginx/sbin/nginx -s stop</li><li>优雅停止服务：/usr/local/nginx/sbin/nginx -s quit</li><li>检查配置文件：/usr/local/nginx/sbin/nginx -t</li><li>重新加载配置：/usr/local/nginx/sbin/nginx -s reload</li><li>查看相关进程：ps -ef | grep nginx</li></ul> 
<p><strong>开放防火墙：</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /etc/rc.d/init.d/iptables save</span>
iptables：将防火墙规则保存到 /etc/sysconfig/iptables：<span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<h3><a name="t23"></a><a name="t23"></a><a id="47_768"></a>4.7、访问测试</h3> 
<p>打开IE浏览器输入：http://192.168.206.128/edu/a.html</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-A2BNMQdu-1599441221247)(assets/20200829000323.png)]</p> 
<p>打开IE浏览器输入： http://192.168.206.128/edu/a.html</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-iX5Eeg6z-1599441221250)(assets/20200829000403.png)]</p> 
<h3><a name="t24"></a><a name="t24"></a><a id="48nginx_778"></a>4.8、如何保证主nginx高可用</h3> 
<p>请您参考：学习Nginx这一篇就够了中的高可用集群如何搭建的。</p> 
<p>原理说明：准备两台Nginx，一主一备，每一台上安装一个keepalived，由keepalived负责监测当前机器上的nginx是否可用（其实是调用一个shell脚本不停的查看进程信息），同时也会在两个keepalived之间进行心跳监测，如果主节点宕机，则从节点自动跟上，访问是通过虚拟IP进行访问的。</p> 
<h3><a name="t25"></a><a name="t25"></a><a id="49session_784"></a>4.9、如何解决session共享问题</h3> 
<p><strong>方案一：ip_hash 策略</strong></p> 
<p>通过修改Nginx配置文件，让每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。 例如：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYxODQzMDAucG5n?x-oss-process=image/format,png" alt="image-20200829001054083"></p> 
<p><strong>方案二：session 复制</strong></p> 
<p>在每台Tomcat的 conf/server.xml 配置如下:</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Cluster</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.catalina.ha.tcp.SimpleTcpCluster<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>在每台Tomcat部署的应用程序中，例如：servlet_demo 的 web.xml 中加入如下配置 ：</p> 
<pre class="prettyprint"><code class="prism language-xml has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>distributable</span><span class="token punctuation">/&gt;</span></span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<blockquote> 
 <p>注意：上述方案，适用于较小的集群环境（节点数不超过4个），如果集群的节点数比较多的话，通过这种广播的形式来完成Session的复制，会消耗大量的网络带宽，影响服务的性能。</p> 
</blockquote> 
<h2><a name="t26"></a><a name="t26"></a><a id="_Tomcat_808"></a>第五章 Tomcat安全问题</h2> 
<h3><a name="t27"></a><a name="t27"></a><a id="51_810"></a>5.1、配置安全</h3> 
<ul><li>删除webapps目录下的所有文件</li><li>禁用tomcat管理界面</li><li>注释或删除tomcat-users.xml文件内的所有用户权限</li><li>更改关闭tomcat指令或禁用</li><li>定义错误页面</li></ul> 
<h3><a name="t28"></a><a name="t28"></a><a id="52_818"></a>5.2、应用安全</h3> 
<p>在大部分的Web应用中，特别是一些后台应用系统，都会实现自己的安全管理模块（权 限模块），用于控制应用系统的安全访问，基本包含两个部分：认证（登录/单点登录） 和授权（功能权限、数据权限）两个部分。对于当前的业务系统，可以自己做一套适用 于自己业务系统的权限模块，也有很多的应用系统直接使用一些功能完善的安全框架， 将其集成到我们的web应用中，如：SpringSecurity、Apache Shiro等。</p> 
<h3><a name="t29"></a><a name="t29"></a><a id="53_822"></a>5.3、传输安全</h3> 
<p>HTTPS的全称是超文本传输安全协议（Hypertext Transfer Protocol Secure），是一种网络安全传输协议。在HTTP的基础上加入SSL/TLS来进行数据加密，保护交换数据不被泄露、窃取。</p> 
<p>SSL 和 TLS 是用于网络通信安全的加密协议，它允许客户端和服务器之间通过安全链接 通信。SSL 协议的3个特性：</p> 
<ul><li>保密：通过SSL链接传输的数据时加密的。</li><li>鉴别：通信双方的身份鉴别，通常是可选的，单至少有一方需要验证。</li><li>完整性：传输数据的完整性检查。</li></ul> 
<p>从性能角度考虑，加解密是一项计算昂贵的处理，因为尽量不要将整个Web应用采用SSL 链接， 实际部署过程中， 选择有必要进行安全加密的页面（存在敏感信息传输的页面） 采用SSL通信。</p> 
<p>HTTPS和HTTP的区别主要为以下四点：</p> 
<ul><li>HTTPS协议需要到证书颁发机构CA申请SSL证书，然后与域名进行绑定，HTTP不用申请证书。</li><li>HTTP是超文本传输协议，属于应用层信息传输，HTTPS则是具有SSL加密传安全性传输协议，对数据的传输进行加密，相当于HTTP的升级版。</li><li>HTTP和HTTPS使用的是完全不同的连接方式，用的端口也不一样，前者是8080，后者是8443。</li><li>HTTP的连接很简单，是无状态的、HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比HTTP协议安全。</li></ul> 
<p>HTTPS协议优势：</p> 
<ul><li>提高网站排名，有利于SEO。谷歌已经公开声明两个网站在搜索结果方面相同，如果 一个网站启用了SSL，它可能会获得略高于没有SSL网站的等级，而且百度也表明对安装了SSL的网站表示友好。因此，网站上的内容中启用SSL都有明显的SEO优势。</li><li>隐私信息加密，防止流量劫持。特别是涉及到隐私信息的网站，互联网大型的数据泄露的事件频发发生，网站进行信息加密势在必行。</li><li>浏览器受信任。 自从各大主流浏览器大力支持HTTPS协议之后，访问HTTP的网站都会提示“不安全”的警告信息。</li></ul> 
<p>Tomcat支持HTTPS：这里采用单实例版本的Tomcat进行配置测试</p> 
<p><strong>第一步：查找秘钥库生成器，这个工具是Java提供的</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># find / -name keytool</span>
/usr/bin/keytool
/usr/lib/jvm/java-1.6.0-openjdk-1.6.0.41.x86_64/jre/bin/keytool
/usr/lib/jvm/java-1.7.0-openjdk-1.7.0.181.x86_64/jre/bin/keytool
/etc/alternatives/keytool
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li></ul></pre> 
<p><strong>第二步：生成秘钥库文件</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/lib/jvm/java-1.7.0-openjdk-1.7.0.181.x86_64/jre/bin/keytool -genkey -alias tomcat -keyalg RSA -keystore tomcatkey.keystore</span>
输入密钥库口令:  
再次输入新口令: 
您的名字与姓氏是什么?（这里使用的必须是域名）
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  www.abc.com
您的组织单位名称是什么?
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  abc
您的组织名称是什么?
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  abc
您所在的城市或区域名称是什么?
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  BeiJing
您所在的省/市/自治区名称是什么?
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  BeiJing
该单位的双字母国家/地区代码是什么?
  <span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:  CN
CN<span class="token operator">=</span>www.abc.com, OU<span class="token operator">=</span>abc, O<span class="token operator">=</span>abc, L<span class="token operator">=</span>BeiJing, ST<span class="token operator">=</span>BeiJing, C<span class="token operator">=</span>CN是否正确?
  <span class="token punctuation">[</span>否<span class="token punctuation">]</span>:  Y

输入 <span class="token operator">&lt;</span>tomcat<span class="token operator">&gt;</span> 的密钥口令
        <span class="token punctuation">(</span>如果和密钥库口令相同, 按回车<span class="token punctuation">)</span>:  

Warning:
JKS 密钥库使用专用格式。建议使用 <span class="token string">"keytool -importkeystore -srckeystore tomcatkey.keystore -destkeystore tomcatkey.keystore -deststoretype pkcs12"</span> 迁移到行业标准格式 PKCS12。
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li></ul></pre> 
<p><strong>第三步：将秘钥库文件 tomcatkey.keystore 复制到tomcat/conf 目录下</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># cp tomcatkey.keystore /usr/local/tomcat/conf/</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第四步：配置tomcat/conf/server.xml</strong></p> 
<p>先删除：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /usr/local/tomcat/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>再添加：</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># vi /usr/local/tomcat/conf/server.xml</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Server port<span class="token operator">=</span><span class="token string">"8005"</span> shutdown<span class="token operator">=</span><span class="token string">"SHUTDOWN"</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.startup.VersionLoggerListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.AprLifecycleListener"</span> SSLEngine<span class="token operator">=</span><span class="token string">"on"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>Listener className<span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /<span class="token operator">&gt;</span>

	<span class="token operator">&lt;</span>GlobalNamingResources<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Resource name<span class="token operator">=</span><span class="token string">"UserDatabase"</span> auth<span class="token operator">=</span><span class="token string">"Container"</span> type<span class="token operator">=</span><span class="token string">"org.apache.catalina.UserDatabase"</span> description<span class="token operator">=</span><span class="token string">"User database that can be updated and saved"</span> factory<span class="token operator">=</span><span class="token string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span> pathname<span class="token operator">=</span><span class="token string">"conf/tomcat-users.xml"</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/GlobalNamingResources<span class="token operator">&gt;</span>



	<span class="token operator">&lt;</span>Service name<span class="token operator">=</span><span class="token string">"Catalina"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Connector port<span class="token operator">=</span><span class="token string">"8080"</span> protocol<span class="token operator">=</span><span class="token string">"HTTP/1.1"</span> connectionTimeout<span class="token operator">=</span><span class="token string">"20000"</span> redirectPort<span class="token operator">=</span><span class="token string">"8443"</span> /<span class="token operator">&gt;</span>

		<span class="token operator">&lt;</span><span class="token operator">!</span>-- 主要新增的代码 --<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>Connector port<span class="token operator">=</span><span class="token string">"8443"</span> protocol<span class="token operator">=</span><span class="token string">"org.apache.coyote.http11.Http11NioProtocol"</span> maxThreads<span class="token operator">=</span><span class="token string">"150"</span> schema<span class="token operator">=</span><span class="token string">"https"</span> secure<span class="token operator">=</span><span class="token string">"true"</span> SSLEnabled<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>SSLHostConfig certificateVerification<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>Certificate certificateKeystoreFile<span class="token operator">=</span><span class="token string">"/usr/local/tomcat/conf/tomcatkey.keystore"</span> certificateKeystorePassword<span class="token operator">=</span><span class="token string">"123456"</span> type<span class="token operator">=</span><span class="token string">"RSA"</span> /<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/SSLHostConfig<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/Connector<span class="token operator">&gt;</span>

		<span class="token operator">&lt;</span>Engine name<span class="token operator">=</span><span class="token string">"Catalina"</span> defaultHost<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.LockOutRealm"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>Realm className<span class="token operator">=</span><span class="token string">"org.apache.catalina.realm.UserDatabaseRealm"</span> resourceName<span class="token operator">=</span><span class="token string">"UserDatabase"</span> /<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/Realm<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>Host name<span class="token operator">=</span><span class="token string">"localhost"</span> appBase<span class="token operator">=</span><span class="token string">"webapps"</span> unpackWARs<span class="token operator">=</span><span class="token string">"true"</span> autoDeploy<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>Valve className<span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> directory<span class="token operator">=</span><span class="token string">"logs"</span> prefix<span class="token operator">=</span><span class="token string">"localhost_access_log"</span> suffix<span class="token operator">=</span><span class="token string">".txt"</span> pattern<span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/Host<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/Engine<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/Service<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/Server<span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li><li style="color: rgb(153, 153, 153);">33</li><li style="color: rgb(153, 153, 153);">34</li></ul></pre> 
<p><strong>第五步：关闭服务器，防止启动失败，然后再启动访问</strong></p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat1/bin/shutdown.sh </span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat2/bin/shutdown.sh  </span>
<span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s quit</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li></ul></pre> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token punctuation">[</span>root@caochenlei ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/tomcat/bin/startup.sh</span>
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>第六步：配置本机域名映射</strong></p> 
<p>复制一份 C:\Windows\System32\drivers\etc\hosts 到桌面，然后新增一条记录，然后再替换回去。</p> 
<pre class="prettyprint"><code class="prism language-shell has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token comment">#虚拟机的IP地址       虚拟域名</span>
192.168.239.144     www.abc.com
<div class="hljs-button {2}" data-title="复制" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.4259&quot;}"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<p>打开浏览器输入：https://www.abc.com:8443/</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDYyMTIyNTkucG5n?x-oss-process=image/format,png" alt="image-20200906212256130"></p> 
<h2><a name="t30"></a><a name="t30"></a><a id="_Tomcat_969"></a>第六章 Tomcat原理分析</h2> 
<h3><a name="t31"></a><a name="t31"></a><a id="61Http_971"></a>6.1、Http工作原理</h3> 
<p>HTTP协议是浏览器与服务器之间的数据传送协议。作为应用层协议，HTTP是基于TCP/IP协议来传递数据的（HTML文件、图片、查询结果等），HTTP协议不涉及数据包（Packet）传输，主要规定了客户端和服务器之间的通信格式。它的整个过程如下图所示：</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODE0MzEucG5n?x-oss-process=image/format,png" alt="image-20200907081429760"></p> 
<ol><li>用户通过浏览器进行了一个操作，比如输入网址并回车，或者是点击链接，接着浏览器获取了这个事件。</li><li>浏览器向服务端发出TCP连接请求。</li><li>服务程序接受浏览器的连接请求并经过TCP三次握手建立连接。</li><li>浏览器将请求数据打包成一个HTTP协议格式的数据包。</li><li>浏览器将该数据包推入网络，数据包经过网络传输，最终达到端服务程序。</li><li>服务端程序拿到这个数据包后，同样以HTTP协议格式解包，获取到客户端的意图。</li><li>得知客户端意图后进行处理，比如提供静态文件或者调用服务端程序获得动态结果。</li><li>服务器将响应结果（可能是HTML或者图片等）按照HTTP协议格式打包。</li><li>服务器将响应数据包推入网络，数据包经过网络传输最终达到到浏览器。</li><li>浏览器拿到数据包后，以HTTP协议的格式解包，然后解析数据，假设这里的数据是 HTML。</li><li>浏览器将HTML文件展示在页面上。</li></ol> 
<p>那我们想要探究的Tomcat作为一个HTTP服务器，在这个过程中都做了些什么事情呢？</p> 
<p>主要是接受连接、解析请求数据、处理请求和发送响应这几个步骤。</p> 
<h3><a name="t32"></a><a name="t32"></a><a id="62Tomcat_993"></a>6.2、Tomcat整体架构</h3> 
<p>Tomcat要实现两个核心功能：</p> 
<ol><li>处理Socket连接，负责网络字节流与Request和Response对象的转化。</li><li>加载和管理Servlet，以及具体处理Request请求。</li></ol> 
<p>因此Tomcat设计了两个核心组件连接器（Connector）和容器（Container）来分别做这 两件事情。连接器负责对外交流，容器负责内部处理。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODE5MzkucG5n?x-oss-process=image/format,png" alt="image-20200907081935758"></p> 
<h3><a name="t33"></a><a name="t33"></a><a id="63Coyote_1004"></a>6.3、Coyote连接器架构</h3> 
<p>Coyote是Tomcat的连接器框架的名称 , 是Tomcat服务器提供的供客户端访问的外部接口。客户端通过Coyote与服务器建立连接、发送请求并接受响应 。</p> 
<p>Coyote封装了底层的网络通信（Socket请求及响应处理），为Catalina容器提供了统一的接口，使Catalina容器与具体的请求协议及IO操作方式完全解耦。Coyote 将Socket输入转换封装为Request对象，交由Catalina容器进行处理，处理请求完成后，Catalina通过Coyote提供的Response对象将结果写入输出流 。</p> 
<p>Coyote作为独立的模块，只负责具体协议和IO的相关操作，与Servlet规范实现没有直接关系，因此即便是Request和Response对象也并未实现Servlet规范对应的接口， 而是在Catalina中将他们进一步封装为ServletRequest和ServletResponse。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODIzNDUucG5n?x-oss-process=image/format,png" alt="image-20200907082342461"></p> 
<p><strong>在Coyote中，Tomcat支持的IO模型，请看下表：</strong></p> 
<div class="table-box"><table><thead><tr><th>IO模型</th><th>描述</th></tr></thead><tbody><tr><td>NIO</td><td>非阻塞I/O，采用Java NIO类库实现。</td></tr><tr><td>NIO2</td><td>异步I/O，采用JDK 7最新的NIO2类库实现。</td></tr><tr><td>APR</td><td>采用Apache可移植运行库实现，是C/C++编写的本地库。如果选择该方案，需要单独安装APR库。</td></tr></tbody></table></div>
<p><strong>在Coyote中，Tomcat支持的应用层协议，请看下表：</strong></p> 
<div class="table-box"><table><thead><tr><th>应用层协议</th><th>描述</th></tr></thead><tbody><tr><td>HTTP/1.1</td><td>这是大部分Web应用采用的访问协议。</td></tr><tr><td>AJP/1.3</td><td>用于和Web服务器集成（如Apache），以实现对静态资源的优化以及集群部署。</td></tr><tr><td>HTTP/2</td><td>HTTP 2.0大幅度的提升了Web性能。下一代HTTP协议 ， 自8.5以及9.0版本之后支持。</td></tr></tbody></table></div>
<p><strong>协议分层 ：</strong></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODI4NTQucG5n?x-oss-process=image/format,png" alt="image-20200907082850508"></p> 
<p>在8.0之前，Tomcat 默认采用的I/O方式为 BIO，之后改为 NIO。 无论 NIO、NIO2还是 APR，在性能方面均优于以往的BIO。 如果采用APR，甚至可以达到 Apache HTTP Server的影响性能。</p> 
<p>Tomcat为了实现支持多种I/O模型和应用层协议，一个容器可能对接多个连接器，就好比一个房间有多个门。但是单独的连接器或者容器都不能对外提供服务，需要把它们组装起来才能工作，组装后这个整体叫作Service组件。这里请你注意，Service本身没有做什么重要的事情，只是在连接器和容器外面多包了一层，把它们组装在一起。Tomcat内可能有多个Service，这样的设计也是出于灵活性的考虑。通过在Tomcat中配置多个Service，可以实现通过不同的端口号来访问同一台机器上部署的不同应用。</p> 
<p><strong>Coyote的主要组件结构如下：</strong></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODMyMjIucG5n?x-oss-process=image/format,png" alt="image-20200907083219856"></p> 
<p><strong>Coyote的各个组件的作用如下：</strong></p> 
<ul><li> <p><strong>EndPoint</strong><br> EndPoint：Coyote 通信端点，即通信监听的接口，是具体Socket接收和发送处理器，是对传输层的抽象，因此EndPoint用来实现TCP/IP协议的。<br> Tomcat 并没有EndPoint接口，而是提供了一个抽象类AbstractEndpoint，里面定义了两个内部类：Acceptor和SocketProcessor。Acceptor用于监听Socket连接请求。SocketProcessor用于处理接收到的Socket请求，它实现Runnable接口，在Run方法里调用协议处理组件Processor进行处理。为了提高处理力，SocketProcessor被提交到线程池来执行，而这个线程池叫作执行器（Executor）。</p> </li><li> <p><strong>Processor</strong><br> Processor：Coyote 协议处理接口，如果说EndPoint是用来实现TCP/IP协议的，那么Processor用来实现HTTP协议，Processor接收来自EndPoint的Socket，读取字节流解析成Tomcat Request和Response对象，并通过Adapter将其提交到容器处理，Processor是对应用层协议的抽象。</p> </li><li> <p><strong>ProtocolHandler</strong></p> <p>ProtocolHandler：Coyote 协议接口，通过Endpoint和Processor，实现针对具体协议的处理能力。Tomcat按照协议和I/O 提供了6个实现类 ： AjpNioProtocol、AjpNio2Protocol、AjpAprProtocol、Http11NioProtocol、Http11Nio2Protocol、Http11AprProtocol。我们在配置tomcat / conf / server.xml时，至少要指定具体的ProtocolHandler , 当然也可以指定协议名称，如：HTTP/1.1，如果安装了APR，那么将使用Http11AprProtocol，否则使用 Http11NioProtocol 。</p> </li><li> <p><strong>Adapter</strong></p> <p>由于协议不同，客户端发过来的请求信息也不尽相同，Tomcat定义了自己的Request类 来“存放”这些请求信息。ProtocolHandler接口负责解析请求并生成Tomcat Request类。 但是这个Request对象不是标准的ServletRequest，也就意味着，不能用Tomcat Request作为参数来调用容器。Tomcat设计者的解决方案是引入CoyoteAdapter，这是 适配器模式的经典运用，连接器调用CoyoteAdapter的Sevice方法，传入的是Tomcat Request对象，CoyoteAdapter负责将Tomcat Request转成ServletRequest，再调用容器的Service方法。</p> </li></ul> 
<h3><a name="t34"></a><a name="t34"></a><a id="64Catalina_1059"></a>6.4、Catalina容器架构</h3> 
<p><strong>Tomcat的模块分层结构如下：</strong></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODQxMjYucG5n?x-oss-process=image/format,png" alt="image-20200907084122883"></p> 
<p>Tomcat本质上就是一款 Servlet 容器，因此Catalina 才是 Tomcat 的核心，其他模块都是为Catalina提供支撑的。比如：通过Coyote模块提供连接通信，Jasper 模块提供JSP引擎，Naming 提供JNDI 服务，Juli提供日志服务。</p> 
<p><strong>Catalina的主要组件结构如下：</strong></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODQ0MjcucG5n?x-oss-process=image/format,png" alt="image-20200907084424992"></p> 
<p><strong>Catalina的各个组件的作用如下：</strong></p> 
<ul><li> <p><strong>Catalina</strong></p> <p>负责解析Tomcat的配置文件 , 以此来创建服务器Server组件，并根据 命令来对其进行管理。</p> </li><li> <p><strong>Server</strong></p> <p>服务器表示整个Catalina Servlet容器以及其它组件，负责组装并启动Servlet引擎、Tomcat连接器。Server通过实现Lifecycle接口，提供了 一种优雅的启动和关闭整个系统的方式。</p> </li><li> <p><strong>Service</strong></p> <p>服务是Server内部的组件，一个Server包含多个Service。它将若干个Connector组件绑定到一个Container（Engine）上。</p> </li><li> <p><strong>Connector</strong></p> <p>连接器主要是处理与客户端的通信，它负责接收客户请求，然后转给相关的容器处理，最后向客户返回响应结果。</p> </li><li> <p><strong>Container</strong></p> <p>容器负责处理用户的Servlet请求，并返回对象给web用户的模块。</p> </li></ul> 
<p><strong>Container的主要组件结构如下：</strong></p> 
<p>Tomcat设计了4种容器，分别是Engine、Host、Context和Wrapper。这4种容器不是平行关系，而是父子关系。Tomcat通过一种分层的架构，使得Servlet容器具有很好的灵活性。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODUxMDYucG5n?x-oss-process=image/format,png" alt="image-20200907085102815"></p> 
<p><strong>Container的各个组件的作用如下：</strong></p> 
<ul><li> <p><strong>Engine</strong></p> <p>表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可包含多个Host。</p> </li><li> <p><strong>Host</strong></p> <p>代表一个虚拟主机或者说一个站点，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context。</p> </li><li> <p><strong>Context</strong></p> <p>表示一个Web应用程序， 一个Web应用可包含多个Wrapper。</p> </li><li> <p><strong>Wrapper</strong></p> <p>表示一个Servlet，Wrapper 作为容器中的最底层，不能包含子容器。</p> </li></ul> 
<p>我们也可以再通过Tomcat的server.xml配置文件来加深对Tomcat容器的理解。Tomcat采用了组件化的设计，它的构成组件都是可配置的，其中最外层的是Server，其他组件按照一定的格式要求配置在这个顶层容器中。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODU0NTcucG5n?x-oss-process=image/format,png" alt="image-20200907085454219"></p> 
<p>那么，Tomcat是怎么管理这些容器的呢？你会发现这些容器具有父子关系，形成一个树形结构，你可能马上就想到了设计模式中的组合模式。没错，Tomcat就是用组合模式来管理这些容器的。具体实现方法是，所有容器组件都实现了Container接口，因此组合模式可以使得用户对单容器对象和组合容器对象的使用具有一致性。这里单容器对象指的是最底层的Wrapper，组合容器对象指的是上面的Context、Host或者Engine。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODU3MjQucG5n?x-oss-process=image/format,png" alt="image-20200907085721607"></p> 
<h3><a name="t35"></a><a name="t35"></a><a id="65Jasper_1125"></a>6.5、Jasper处理流程</h3> 
<p>Tomcat在默认的web.xml中配置了一个org.apache.jasper.servlet.JspServlet，用于处理所有的.jsp或 .jspx结尾的请求，该Servlet 实现即是运行时编译的入口。</p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwOTAxMzMucG5n?x-oss-process=image/format,png" alt="image-20200907090131426"></p> 
<p><strong>JspServlet 处理流程图：</strong></p> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwOTAyMDYucG5n?x-oss-process=image/format,png" alt="image-20200907090204389"></p> 
<ul><li>如果在 tomcat/conf/web.xml 中配置了参数scratchdir，则jsp编译后的结果，就会存储在该目录下 。</li><li>如果没有配置该选项，则会将编译后的结果，存储在Tomcat安装目录下的 work/Catalina(Engine名称)/localhost(Host名称)/Context名称 。</li></ul> 
<p>除了运行时编译，我们还可以直接在Web应用启动时， 一次性将Web应用中的所有的JSP页面一次性编译完成。在这种情况下，Web应用运行过程中，便可以不必再进行实时编译，而是直接调用JSP页面对应的Servlet完成请求处理， 从而提升系统性能。</p> 
<p>Tomcat 提供了一个Shell程序JspC，用于支持JSP预编译，而且在Tomcat的安装目录下提供了一个 catalina-tasks.xml 文件声明了Tomcat 支持的Ant任务， 因此，我们很容易使用 Ant 来执行JSP 预编译。（要想使用这种方式，必须得确保在此之前已经下载并安装了Apache Ant）。</p> 
<h3><a name="t36"></a><a name="t36"></a><a id="66JSP_1142"></a>6.6、JSP编译过程</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwOTA3NDkucG5n?x-oss-process=image/format,png" alt="image-20200907090746567"></p> 
<p><strong>Compiler 编译工作主要包含代码生成和编译两部分：</strong></p> 
<ul><li> <p>代码生成</p> 
  <ul><li>1） Compiler 通过一个 PageInfo 对象保存JSP 页面编译过程中的各种配置，这些配置可能来源于 Web 应用初始化参数， 也可能来源于JSP页面的指令配置（如 page ， include）。</li><li>2） 调用ParserController 解析指令节点， 验证其是否合法，同时将配置信息保存到 PageInfo 中， 用于控制代码生成。</li><li>3） 调用ParserController 解析整个页面， 由于 JSP 是逐行解析， 所以对于每一行会创建一个具体的Node 对象。如静态文本（TemplateText）、Java代码（Scriptlet）、定制标签（CustomTag）、Include指令（IncludeDirective）。</li><li>4） 验证除指令外其他所有节点的合法性， 如脚本、定制标签、EL表达式等。</li><li>5） 收集除指令外其他节点的页面配置信息。</li><li>6） 编译并加载当前 JSP 页面依赖的标签。</li><li>7） 对于JSP页面的EL表达式，生成对应的映射函数。</li><li>8） 生成JSP页面对应的Servlet类源代码 编译 代码生成完成后，Compiler还会生成 SMAP信息。 如果配置生成 SMAP信息，Compiler则会在编译阶段将SMAP信息写到class文件中 。</li></ul> </li><li> <p>编译阶段</p> <p>Compiler的两个实现 AntCompiler 和 JDTCompiler 分别调用先关框架的 API 进行源代码编译。</p> <p>对于 AntCompiler 来说， 构造一个 Ant 的javac 的任务完成编译。</p> <p>对于 JDTCompiler 来说， 调用 org.eclipse.jdt.internal.compiler.Compiler 完成编译。</p> </li></ul> 
<h3><a name="t37"></a><a name="t37"></a><a id="67Tomcat_1167"></a>6.7、Tomcat启动流程</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODU3NTUucG5n?x-oss-process=image/format,png" alt="image-20200907085753038"></p> 
<h3><a name="t38"></a><a name="t38"></a><a id="68Tomcat_1171"></a>6.8、Tomcat请求处理流程</h3> 
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vY2FvY2hlbmxlaS9CbG9nSW1hZ2VzL3Jhdy9tYXN0ZXIvMjAyMDA5MDcwODU4MTcucG5n?x-oss-process=image/format,png" alt="image-20200907085815693"></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;dest&quot;:&quot;https://caochenlei.blog.csdn.net/article/details/108440922&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-d7a94ec6ab.css" rel="stylesheet">
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-ba784fbaf8.css" rel="stylesheet">
        </div>